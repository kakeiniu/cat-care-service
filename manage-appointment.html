<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>自助修改/取消预约</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: linear-gradient(135deg, #FFF1F4 0%, #FFE1E8 100%);
      min-height: 100vh;
      color: #222;
    }
    .container {
      max-width: 760px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(255, 182, 193, 0.15);
      padding: 30px;
    }
    h1 {
      margin: 0 0 10px;
      font-size: 24px;
      color: #333;
      padding-bottom: 12px;
      border-bottom: 3px solid #FFC7D2;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .desc {
      margin: 0 0 20px;
      color: #666;
      font-size: 14px;
      line-height: 1.6;
    }
    .section {
      border: 2px solid #FFD1DB;
      border-radius: 10px;
      padding: 18px;
      margin-bottom: 18px;
      background: #FFF7FA;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
      color: #555;
    }
    input, textarea, select {
      width: 100%;
      margin-top: 5px;
      padding: 10px;
      border: 2px solid #e5e5e5;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #FFC7D2;
      box-shadow: 0 0 8px rgba(255, 182, 193, 0.25);
    }
    textarea { min-height: 90px; resize: vertical; }
    .row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    button {
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #FFC7D2 0%, #FFB9C8 100%);
      color: #fff;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(255, 182, 193, 0.25);
    }
    button:hover { 
      background: linear-gradient(135deg, #FFB9C8 0%, #FFA9BD 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 182, 193, 0.3);
    }
    .danger { 
      background: linear-gradient(135deg, #FF9EAD 0%, #F07A8E 100%);
      box-shadow: 0 4px 15px rgba(255, 122, 138, 0.25);
    }
    .danger:hover { 
      background: linear-gradient(135deg, #F07A8E 0%, #E56B80 100%);
      box-shadow: 0 6px 20px rgba(255, 122, 138, 0.35);
    }
    .message {
      margin-top: 12px;
      border-radius: 8px;
      padding: 12px;
      display: none;
      font-size: 14px;
    }
    .ok { 
      background: #FFF4F7; 
      color: #B96A80; 
      border: 2px solid #FFD1DB; 
    }
    .err { 
      background: #FFF1F3; 
      color: #C96A7B; 
      border: 2px solid #FF9EAD; 
    }
    .tip {
      margin-top: 10px;
      color: #777;
      font-size: 12px;
      line-height: 1.5;
    }
    .hide { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>修改/取消预约</h1>
    <p class="desc">可通过预约号直接查找；若忘记预约号，可用联系方式类型 + 联系方式 + 猫咪名字找回。</p>

    <div class="section">
      <strong>方式一：使用预约号</strong>
      <label>预约号</label>
      <input id="lookupReservationNumber" placeholder="例如：YY202602230123" />
      <div class="row">
        <button type="button" id="findByReservationBtn">查找预约</button>
      </div>
    </div>

    <div class="section">
      <strong>方式二：忘记预约号（找回）</strong>
      <label>联系方式类型</label>
      <select id="findContactType">
        <option value="">-- 请选择 --</option>
        <option value="电话">电话</option>
        <option value="微信">微信</option>
        <option value="邮箱">邮箱</option>
      </select>
      <label>联系方式</label>
      <input id="findContact" placeholder="请输入提交时填写的联系方式" />
      <label>猫咪名字</label>
      <input id="findCatName" placeholder="请输入猫咪名字" />
      <div class="row">
        <button type="button" id="findByInfoBtn">找回预约</button>
      </div>
      <div class="tip">联系方式类型和联系方式需与提交时一致，系统将匹配最近一条未取消记录。</div>
    </div>

    <div id="message" class="message"></div>
  </div>

  <script>
    function showMessage(text, type) {
      var box = document.getElementById("message");
      box.className = "message " + (type === "ok" ? "ok" : "err");
      box.textContent = text;
      box.style.display = "block";
    }

    function hideMessage() {
      var box = document.getElementById("message");
      box.style.display = "none";
    }

    function goToDetailPage(reservationNumber) {
      if (!reservationNumber) return;
      window.location.href = "/manage-appointment-detail.html?reservationNumber=" + encodeURIComponent(reservationNumber);
    }

    function requestJson(url, method, body, success, failure) {
      if (typeof fetch !== "undefined") {
        fetch(url, {
          method: method,
          headers: { "Content-Type": "application/json" },
          body: body ? JSON.stringify(body) : undefined,
          cache: "no-store"
        })
          .then(function(res) { return res.json(); })
          .then(success)
          .catch(function() { failure("网络错误，请重试"); });
      } else {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4) {
            try {
              var json = JSON.parse(xhr.responseText || "{}");
              success(json);
            } catch (e) {
              failure("网络错误，请重试");
            }
          }
        };
        xhr.onerror = function() { failure("网络错误，请重试"); };
        xhr.open(method, url);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(body ? JSON.stringify(body) : null);
      }
    }

    function findByReservation() {
      hideMessage();
      var number = (document.getElementById("lookupReservationNumber").value || "").trim();
      if (!number) {
        alert("请输入预约号");
        showMessage("请输入预约号", "err");
        return;
      }

      requestJson(
        "/api/customer/appointment/" + encodeURIComponent(number) + "?t=" + Date.now(),
        "GET",
        null,
        function(result) {
          if (!result || !result.success || !result.data) {
            var errMsg = "未匹配到预约信息，请核对后再试";
            alert(errMsg);
            showMessage(errMsg, "err");
            return;
          }
          goToDetailPage(result.data.reservationNumber || number);
        },
        function(msg) { showMessage(msg, "err"); }
      );
    }

    function findByInfo() {
      hideMessage();
      var contactType = (document.getElementById("findContactType").value || "").trim();
      var contact = (document.getElementById("findContact").value || "").trim();
      var catName = (document.getElementById("findCatName").value || "").trim();

      if (!contactType || !contact || !catName) {
        alert("请填写联系方式类型、联系方式、猫咪名字");
        showMessage("请填写联系方式类型、联系方式、猫咪名字", "err");
        return;
      }

      requestJson(
        "/api/customer/find?t=" + Date.now(),
        "POST",
        { contactType: contactType, contact: contact, catName: catName },
        function(result) {
          if (!result || !result.success || !result.data) {
            var errMsg = "未匹配到预约信息，请核对后再试";
            alert(errMsg);
            showMessage(errMsg, "err");
            return;
          }
          goToDetailPage(result.data.reservationNumber || "");
        },
        function(msg) { showMessage(msg, "err"); }
      );
    }

    document.getElementById("findByReservationBtn").onclick = findByReservation;
    document.getElementById("findByInfoBtn").onclick = findByInfo;
  </script>
</body>
</html>