<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>提交详情</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: #f5f5f5;
      color: #222;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      padding: 20px;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 22px;
    }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }
    .btn {
      border: none;
      border-radius: 6px;
      background: #4caf50;
      color: #fff;
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
    }
    .btn:hover { background: #45a049; }
    .status {
      font-size: 13px;
      color: #666;
    }
    .panel {
      border: 1px solid #e7e7e7;
      border-radius: 8px;
      background: #fafafa;
      padding: 12px;
    }
    .row {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 8px;
      margin-top: 8px;
      font-size: 14px;
    }
    .label {
      color: #666;
      font-weight: 600;
    }
    .visit-item {
      margin: 4px 0;
    }
    .error {
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      background: #fdecec;
      color: #a32626;
    }
    .badge {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
    }
    .badge-read {
      background: #e9f3ea;
      color: #2f6f33;
    }
    .badge-unread {
      background: #fff4dd;
      color: #a86a00;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>客户提交详情</h1>
    <div class="toolbar">
      <button id="backBtn" type="button" class="btn">返回列表</button>
      <button id="refreshBtn" type="button" class="btn">刷新</button>
      <span id="status" class="status">准备加载...</span>
    </div>

    <div id="message"></div>
    <div id="content" class="panel"></div>
  </div>

  <script>
    function escapeHtml(text) {
      var value = text == null ? "" : String(text);
      return value
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function formatDateTime(value) {
      if (!value) return "-";
      var date = new Date(value);
      if (isNaN(date.getTime())) return value;
      return date.toLocaleString("zh-CN", { hour12: false });
    }

    function getQueryParam(name) {
      var search = window.location.search || "";
      var query = search.replace(/^\?/, "").split("&");
      for (var i = 0; i < query.length; i++) {
        var pair = query[i].split("=");
        if (decodeURIComponent(pair[0] || "") === name) {
          return decodeURIComponent(pair[1] || "");
        }
      }
      return "";
    }

    function buildVisitHtml(visits) {
      if (!visits || !visits.length) return "-";
      var html = "";
      for (var i = 0; i < visits.length; i++) {
        var item = visits[i] || {};
        html += '<div class="visit-item">' + escapeHtml((item.date || '-') + ' / ' + (item.time || '-')) + '</div>';
      }
      return html;
    }

    function setStatus(text) {
      document.getElementById("status").textContent = text;
    }

    function showError(text) {
      document.getElementById("message").innerHTML = '<div class="error">' + escapeHtml(text) + '</div>';
      document.getElementById("content").innerHTML = "";
    }

    function renderDetail(item) {
      document.getElementById("message").innerHTML = "";
      var content = document.getElementById("content");
      var isRead = item && item.isRead === true;
      content.innerHTML = '' +
        '<div class="row"><div class="label">阅读状态</div><div><span class="badge ' + (isRead ? 'badge-read' : 'badge-unread') + '">' + (isRead ? '已读' : '未读') + '</span></div></div>' +
        '<div class="row"><div class="label">提交时间</div><div>' + escapeHtml(formatDateTime(item.createdAt)) + '</div></div>' +
        '<div class="row"><div class="label">联系方式</div><div>' + escapeHtml((item.contactType || '-') + ' / ' + (item.contact || '-')) + '</div></div>' +
        '<div class="row"><div class="label">猫咪名字</div><div>' + escapeHtml(item.catName || '-') + '</div></div>' +
        '<div class="row"><div class="label">猫咪年龄</div><div>' + escapeHtml(item.catAge || '-') + '</div></div>' +
        '<div class="row"><div class="label">上门地址</div><div>' + escapeHtml(item.address || '-') + '</div></div>' +
        '<div class="row"><div class="label">上门安排</div><div>' + buildVisitHtml(item.visits) + '</div></div>' +
        '<div class="row"><div class="label">备注</div><div>' + escapeHtml(item.note || '-') + '</div></div>' +
        '<div class="row"><div class="label">记录 ID</div><div>' + escapeHtml(item._id || '-') + '</div></div>';
    }

    function loadDetail() {
      var id = getQueryParam("id");
      if (!id) {
        showError("缺少记录 ID，无法加载详情");
        setStatus("加载失败");
        return;
      }

      setStatus("加载中...");

      var done = function(result) {
        if (!result || !result.success || !result.data) {
          showError((result && result.message) || "加载详情失败");
          setStatus("加载失败");
          return;
        }
        renderDetail(result.data);
        setStatus("加载成功");
      };

      var fail = function() {
        showError("网络错误，无法加载详情");
        setStatus("加载失败");
      };

      if (typeof fetch !== "undefined") {
        fetch("/api/appointments/" + encodeURIComponent(id))
          .then(function(res) { return res.json(); })
          .then(done)
          .catch(fail);
      } else {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              try {
                done(JSON.parse(xhr.responseText));
              } catch (e) {
                fail();
              }
            } else {
              fail();
            }
          }
        };
        xhr.onerror = fail;
        xhr.open("GET", "/api/appointments/" + encodeURIComponent(id));
        xhr.send();
      }
    }

    document.getElementById("backBtn").onclick = function() {
      window.location.href = "/submissions.html";
    };
    document.getElementById("refreshBtn").onclick = loadDetail;

    loadDetail();
  </script>
</body>
</html>
