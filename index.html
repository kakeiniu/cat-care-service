<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>çŒ«å’ªä¸Šé—¨çœ‹æŠ¤é¢„çº¦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .box {
      max-width: 520px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    .required { color: red; }
    input, textarea, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #4caf50;
      box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
    }
    input:disabled, input.past-date {
      background-color: #e8e8e8 !important;
      color: #999 !important;
      cursor: not-allowed !important;
      opacity: 0.6;
    }
    button {
      width: 100%;
      margin-top: 20px;
      padding: 10px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: background 0.3s;
    }
    button:hover:not(:disabled) {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .message {
      margin-top: 15px;
      padding: 12px;
      border-radius: 4px;
      display: none;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .loading {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .date-row {
      display: -webkit-flex;
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 5px;
    }
    .date-row input {
      flex: 1;
      margin-top: 0;
    }
    .small-btn {
      width: auto;
      margin-top: 0;
      padding: 8px 12px;
      font-size: 14px;
      white-space: nowrap;
    }
    .date-list {
      margin-top: 8px;
      display: -webkit-flex;
      display: flex;
      -webkit-flex-wrap: wrap;
      flex-wrap: wrap;
      gap: 8px;
    }
    .date-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #eef7ef;
      border: 1px solid #cfe8d1;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 13px;
    }
    .date-tag button {
      width: auto;
      margin-top: 0;
      padding: 2px 6px;
      font-size: 12px;
      background: #d9534f;
      border-radius: 999px;
    }
    .date-help {
      margin-top: 6px;
      font-size: 12px;
      color: #666;
    }
    .visit-list {
      margin-top: 8px;
      display: -webkit-flex;
      display: flex;
      -webkit-flex-direction: column;
      flex-direction: column;
      gap: 8px;
    }
    .visit-row {
      display: -webkit-flex;
      display: flex;
      gap: 8px;
      -webkit-align-items: center;
      align-items: center;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 8px;
      background: #fafafa;
    }
    .visit-date {
      min-width: 120px;
      font-weight: bold;
      color: #333;
    }
    .visit-time {
      flex: 1;
      margin-top: 0;
    }
  </style>


</head>

<body>
  <div class="box">
    <h2>ğŸ± çŒ«å’ªä¸Šé—¨çœ‹æŠ¤é¢„çº¦</h2>

    <label>è”ç³»æ–¹å¼ç±»å‹ <span class="required">*</span></label>
    <select id="contactType">
      <option value="">-- è¯·é€‰æ‹© --</option>
      <option value="ç”µè¯">ç”µè¯</option>
      <option value="å¾®ä¿¡">å¾®ä¿¡</option>
      <option value="é‚®ç®±">é‚®ç®±</option>
    </select>

    <label>è”ç³»æ–¹å¼ <span class="required">*</span></label>
    <input id="contact" placeholder="æ‰‹æœºï¼š090-1234-5678ï¼›å›ºå®šç”µè¯ï¼š0456-12-3456ï¼›é‚®ç®±ï¼šxxx@example.comï¼›å¾®ä¿¡ï¼šxxxxxxx" />

    <label>å®¢æˆ·å§“å <span class="required">*</span></label>
    <input id="ownerName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" />

    <label>ä¸Šé—¨åœ°åŒºï¼ˆéƒ½é“åºœçœŒï¼‰ <span class="required">*</span></label>
    <select id="prefecture" onchange="updateWard()">
      <option value="">-- è¯·é€‰æ‹©éƒ½é“åºœçœŒ --</option>
      <option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option>
      <option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option>
      <option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option>
      <option value="åƒè‘‰çœŒ">åƒè‘‰çœŒ</option>
    </select>

    <div id="citySection" style="display: none;">
      <label>ä¸Šé—¨åœ°åŒºï¼ˆå¸‚ï¼‰ <span class="required">*</span></label>
      <select id="city" onchange="updateDistrict()">
        <option value="">-- å…ˆé€‰æ‹©éƒ½é“åºœçœŒ --</option>
      </select>
    </div>

    <label>ä¸Šé—¨åœ°åŒºï¼ˆåŒºï¼‰ <span class="required">*</span></label>
    <select id="district">
      <option value="">-- å…ˆé€‰æ‹©å¸‚ --</option>
    </select>

    <label>è¯¦ç»†åœ°å€ï¼ˆä»å‡ ä¸ç›®åå¼€å§‹è¾“å…¥ï¼Œä¾‹ï¼š1-2-3 â—‹â—‹ãƒ“ãƒ«3éšï¼‰ <span class="required">*</span></label>
    <input id="addressDetail" placeholder="ä¾‹å¦‚ï¼š1-2-3ã€1ç•ªåœ°1å·ã€â—‹â—‹ãƒ“ãƒ«3éšï¼ˆå‡ ä¸ç›®å‰é¢çš„å†…å®¹è¯·åœ¨ä¸Šæ–¹ä¸‹æ‹‰é€‰æ‹©ï¼‰" />

    <label>çŒ«å’ªåå­— <span class="required">*</span></label>
    <input id="catName" placeholder="è¯·è¾“å…¥çŒ«å’ªåå­—" />

    <label>çŒ«å’ªå¹´é¾„ <span class="required">*</span></label>
    <input id="catAge" placeholder="ä¾‹å¦‚ï¼š3å²" />

    <label>é¢„çº¦æ–¹å¼ <span class="required">*</span></label>
    <select id="bookingMode" onchange="onBookingModeChange()">
      <option value="separate">åˆ†å¼€æ—¥æœŸï¼ˆä¸è¿ç»­ï¼‰</option>
      <option value="range">ä¸€æ®µåŒºé—´ï¼ˆè¿ç»­ï¼‰</option>
    </select>

    <div id="separateDateSection">
      <label>æœåŠ¡æ—¥æœŸï¼ˆåˆ†å¼€æ·»åŠ ï¼‰ <span class="required">*</span></label>
      <div class="date-row">
        <input type="date" id="date" />
        <button type="button" class="small-btn" onclick="addSingleDate()">æ·»åŠ æ—¥æœŸ</button>
      </div>
    </div>

    <div id="rangeDateSection" style="display: none;">
      <label>æœåŠ¡æ—¥æœŸåŒºé—´ <span class="required">*</span></label>
      <div class="date-row">
        <input type="date" id="startDate" />
        <input type="date" id="endDate" />
        <button type="button" class="small-btn" onclick="addDateRange()">æ·»åŠ åŒºé—´</button>
      </div>
    </div>

    <div class="date-help">æ·»åŠ åè¯·ä¸ºæ¯ä¸ªæ—¥æœŸåˆ†åˆ«é€‰æ‹©ä¸Šé—¨æ—¶é—´ï¼›åŒºé—´ä¿®æ”¹æ—¶ä¼šä¿ç•™é‡å æ—¥æœŸçš„æ—¶é—´è®¾ç½®</div>
    <div id="visitList" class="visit-list"></div>

    <label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
    <textarea id="note" placeholder="ä¾‹å¦‚ï¼šçŒ«å’ªæ€§æ ¼ã€ç‰¹æ®Šéœ€æ±‚ç­‰"></textarea>

    <button id="submitBtn" onclick="submitAppointment()">æäº¤é¢„çº¦</button>

    <div id="message" class="message"></div>
    <div class="date-help"><a href="/manage-appointment.html">å·²æœ‰é¢„çº¦ï¼Ÿç‚¹æ­¤æ‰¾å›é¢„çº¦ï¼Œéšåè¿›å…¥ç‹¬ç«‹é¡µé¢ä¿®æ”¹æˆ–å–æ¶ˆ</a></div>
  </div>

  <!-- âœ… EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

  <!-- âœ… åˆå§‹åŒ– -->
  <script>
    emailjs.init("MMb0p4BWJBxDK-Sgk");
  </script>

  <!-- âœ… ä¸šåŠ¡é€»è¾‘ -->
  <script>
    // çº§è”èœå•æ•°æ®ï¼ˆ3å¿å…¨å¸‚ + ä¸œäº¬23åŒºï¼‰
    var areaData = {
      "æ±äº¬éƒ½": {
        type: "ward",
        items: [
          "åƒä»£ç”°åŒº", "ä¸­å¤®åŒº", "æ¸¯åŒº", "æ–°å®¿åŒº", "æ–‡äº¬åŒº", "å°æ±åŒº", "å¢¨ç”°åŒº", "æ±Ÿæ±åŒº",
          "å“å·åŒº", "ç›®é»’åŒº", "å¤§ç”°åŒº", "ä¸–ç”°è°·åŒº", "æ¸‹è°·åŒº", "ä¸­é‡åŒº", "æ‰ä¸¦åŒº", "è±Šå³¶åŒº",
          "åŒ—åŒº", "è’å·åŒº", "æ¿æ©‹åŒº", "ç·´é¦¬åŒº", "è¶³ç«‹åŒº", "è‘›é£¾åŒº", "æ±Ÿæˆ¸å·åŒº"
        ]
      },
      "åŸ¼ç‰çœŒ": {
        type: "city",
        items: [
          "ã•ã„ãŸã¾å¸‚", "å·è¶Šå¸‚", "ç†Šè°·å¸‚", "å·å£å¸‚", "è¡Œç”°å¸‚", "ç§©çˆ¶å¸‚", "æ‰€æ²¢å¸‚", "é£¯èƒ½å¸‚",
          "åŠ é ˆå¸‚", "æœ¬åº„å¸‚", "æ±æ¾å±±å¸‚", "æ˜¥æ—¥éƒ¨å¸‚", "ç‹­å±±å¸‚", "ç¾½ç”Ÿå¸‚", "é´»å·£å¸‚", "æ·±è°·å¸‚",
          "ä¸Šå°¾å¸‚", "è‰åŠ å¸‚", "è¶Šè°·å¸‚", "è•¨å¸‚", "æˆ¸ç”°å¸‚", "å…¥é–“å¸‚", "æœéœå¸‚", "å¿—æœ¨å¸‚",
          "å’Œå…‰å¸‚", "æ–°åº§å¸‚", "æ¡¶å·å¸‚", "ä¹…å–œå¸‚", "åŒ—æœ¬å¸‚", "å…«æ½®å¸‚", "å¯Œå£«è¦‹å¸‚", "ä¸‰éƒ·å¸‚",
          "è“®ç”°å¸‚", "å‚æˆ¸å¸‚", "å¹¸æ‰‹å¸‚", "é¶´ãƒ¶å³¶å¸‚", "æ—¥é«˜å¸‚", "å‰å·å¸‚", "ãµã˜ã¿é‡å¸‚", "ç™½å²¡å¸‚"
        ]
      },
      "ç¥å¥ˆå·çœŒ": {
        type: "city",
        items: [
          "æ¨ªæµœå¸‚", "å·å´å¸‚", "ç›¸æ¨¡åŸå¸‚", "æ¨ªé ˆè³€å¸‚", "å¹³å¡šå¸‚", "éŒå€‰å¸‚", "è—¤æ²¢å¸‚", "å°ç”°åŸå¸‚",
          "èŒ…ãƒ¶å´å¸‚", "é€—å­å¸‚", "ä¸‰æµ¦å¸‚", "ç§¦é‡å¸‚", "åšæœ¨å¸‚", "å¤§å’Œå¸‚", "ä¼Šå‹¢åŸå¸‚", "æµ·è€åå¸‚",
          "åº§é–“å¸‚", "å—è¶³æŸ„å¸‚", "ç¶¾ç€¬å¸‚"
        ]
      },
      "åƒè‘‰çœŒ": {
        type: "city",
        items: [
          "åƒè‘‰å¸‚", "éŠšå­å¸‚", "å¸‚å·å¸‚", "èˆ¹æ©‹å¸‚", "é¤¨å±±å¸‚", "æœ¨æ›´æ´¥å¸‚", "æ¾æˆ¸å¸‚", "é‡ç”°å¸‚",
          "èŒ‚åŸå¸‚", "æˆç”°å¸‚", "ä½å€‰å¸‚", "æ±é‡‘å¸‚", "æ—­å¸‚", "ç¿’å¿—é‡å¸‚", "æŸå¸‚", "å‹æµ¦å¸‚",
          "å¸‚åŸå¸‚", "æµå±±å¸‚", "å…«åƒä»£å¸‚", "æˆ‘å­«å­å¸‚", "é´¨å·å¸‚", "éŒã‚±è°·å¸‚", "å›æ´¥å¸‚", "å¯Œæ´¥å¸‚",
          "æµ¦å®‰å¸‚", "å››è¡—é“å¸‚", "è¢–ã‚±æµ¦å¸‚", "å…«è¡—å¸‚", "å°è¥¿å¸‚", "ç™½äº•å¸‚", "å¯Œé‡Œå¸‚", "å—æˆ¿ç·å¸‚",
          "åŒç‘³å¸‚", "é¦™å–å¸‚", "å±±æ­¦å¸‚", "ã„ã™ã¿å¸‚", "å¤§ç¶²ç™½é‡Œå¸‚"
        ]
      }
    };

    var TOWN_API = "https://geoapi.heartrails.com/api/json?method=getTowns";
    var TIME_OPTIONS = [
      "ä¸Šåˆ 9:00-12:00",
      "ä¸‹åˆ 13:00-17:00",
      "æ™šä¸Š 18:00-21:00"
    ];
    var selectedVisits = [];

    // æ›´æ–°å¸‚/åŒºçš„çº§è”èœå•å‡½æ•°
    function updateWard() {
      var prefecture = document.getElementById("prefecture").value;
      var citySection = document.getElementById("citySection");
      var citySelect = document.getElementById("city");
      var districtSelect = document.getElementById("district");
      
      // æ¸…ç©ºå¸‚å’ŒåŒº
      citySelect.innerHTML = '';
      districtSelect.innerHTML = '';
      
      if (!prefecture) {
        citySelect.innerHTML = '<option value="">-- å…ˆé€‰æ‹©éƒ½é“åºœçœŒ --</option>';
        districtSelect.innerHTML = '<option value="">-- å…ˆé€‰æ‹©å¸‚ --</option>';
        citySection.style.display = 'none';
        return;
      }
      
      var prefData = areaData[prefecture];
      if (prefData.type === "ward") {
        // ä¸œäº¬ç‰¹æ®Šå¤„ç†ï¼šç›´æ¥æ˜¾ç¤ºåŒºï¼Œéšè—å¸‚é€‰æ‹©
        citySection.style.display = 'none';
        citySelect.value = '';
        districtSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©' + prefecture + 'çš„åŒº --</option>';
        prefData.items.forEach(function(ward) {
          var option = document.createElement("option");
          option.value = prefecture + ward;
          option.textContent = ward;
          districtSelect.appendChild(option);
        });
      } else {
        // å…¶ä»–å¿ï¼šæ˜¾ç¤ºå¸‚é€‰æ‹©ï¼Œç„¶åæŒ‰å¸‚åŠ¨æ€åŠ è½½åŒº/ç”ºåŸŸ
        citySection.style.display = 'block';
        citySelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å¸‚ --</option>';
        districtSelect.innerHTML = '<option value="">-- å…ˆé€‰æ‹©å¸‚ --</option>';
        prefData.items.forEach(function(city) {
          var option = document.createElement("option");
          option.value = city;
          option.textContent = city;
          citySelect.appendChild(option);
        });
      }
    }

    // æ›´æ–°åŒºçš„çº§è”èœå•å‡½æ•°
    function updateDistrict() {
      var prefecture = document.getElementById("prefecture").value;
      var city = document.getElementById("city").value;
      var districtSelect = document.getElementById("district");
      
      districtSelect.innerHTML = '';
      
      if (!prefecture || !city) {
        districtSelect.innerHTML = '<option value="">-- å…ˆé€‰æ‹©å¸‚ --</option>';
        return;
      }
      
      districtSelect.innerHTML = '<option value="">-- æ­£åœ¨åŠ è½½åŒº/ç”ºåŸŸ... --</option>';

      var url = TOWN_API + "&prefecture=" + encodeURIComponent(prefecture) + "&city=" + encodeURIComponent(city);
      
      var success = function(json) {
        var locations = (json && json.response && json.response.location) || [];
        var townSet = new Set();
        for (var i = 0; i < locations.length; i++) {
          if (locations[i].town) {
            townSet.add(locations[i].town);
          }
        }
        var towns = Array.prototype.slice.call(townSet);

        districtSelect.innerHTML = '';
        if (towns.length === 0) {
          districtSelect.innerHTML = '<option value="' + city + '">' + city + 'ï¼ˆå…¨åŸŸï¼‰</option>';
          districtSelect.value = city + 'ï¼ˆå…¨åŸŸï¼‰';
          return;
        }

        districtSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©' + city + 'çš„åŒº/ç”ºåŸŸ --</option>';
        towns.forEach(function(town) {
          var option = document.createElement("option");
          option.value = town;
          option.textContent = town;
          districtSelect.appendChild(option);
        });
      };
      
      var error = function() {
        districtSelect.innerHTML = '<option value="' + city + '">' + city + 'ï¼ˆå…¨åŸŸï¼‰</option>';
        districtSelect.value = city + 'ï¼ˆå…¨åŸŸï¼‰';
      };

      if (typeof fetch !== 'undefined') {
        fetch(url)
          .then(function(res) { return res.json(); })
          .then(success)
          .catch(error);
      } else {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              try {
                var json = JSON.parse(xhr.responseText);
                success(json);
              } catch(e) {
                error();
              }
            } else {
              error();
            }
          }
        };
        xhr.onerror = error;
        xhr.open("GET", url);
        xhr.send();
      }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(text, type) {
      var msg = document.getElementById("message");
      msg.textContent = text;
      msg.className = "message " + type;
      msg.style.display = "block";
      if (type === "success") {
        setTimeout(function() {
          msg.style.display = "none";
          clearForm();
        }, 3000);
      }
    }

    function getTodayISO() {
      var today = new Date();
      var yyyy = today.getFullYear();
      var m = today.getMonth() + 1;
      var mm = (m < 10 ? "0" : "") + m;
      var d = today.getDate();
      var dd = (d < 10 ? "0" : "") + d;
      return yyyy + "-" + mm + "-" + dd;
    }

    function onBookingModeChange() {
      var mode = document.getElementById("bookingMode").value;
      var separateSection = document.getElementById("separateDateSection");
      var rangeSection = document.getElementById("rangeDateSection");
      if (mode === "range") {
        separateSection.style.display = "none";
        rangeSection.style.display = "block";
      } else {
        separateSection.style.display = "block";
        rangeSection.style.display = "none";
      }
    }

    function renderVisitList() {
      var visitList = document.getElementById("visitList");
      visitList.innerHTML = "";

      // å¦‚æœæ²¡æœ‰è®¿é—®åˆ—è¡¨ï¼Œä¸æ˜¾ç¤ºä»»ä½•å†…å®¹
      if (!selectedVisits || selectedVisits.length === 0) {
        return;
      }

      selectedVisits.forEach(function(visit) {
        var row = document.createElement("div");
        row.className = "visit-row";

        var dateLabel = document.createElement("span");
        dateLabel.className = "visit-date";
        dateLabel.textContent = visit.date;

        var timeSelect = document.createElement("select");
        timeSelect.className = "visit-time";
        timeSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©ä¸Šé—¨æ—¶é—´ --</option>';
        
        // ç¡®ä¿ TIME_OPTIONS è¢«æ­£ç¡®ä½¿ç”¨
        if (TIME_OPTIONS && TIME_OPTIONS.length > 0) {
          TIME_OPTIONS.forEach(function(timeText) {
            var option = document.createElement("option");
            option.value = timeText;
            option.textContent = timeText;
            if (visit.time === timeText) {
              option.selected = true;
            }
            timeSelect.appendChild(option);
          });
        }
        
        timeSelect.onchange = (function(currentVisitDate) {
          return function(event) {
            updateVisitTime(currentVisitDate, event.target.value);
          };
        })(visit.date);

        var removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "small-btn";
        removeBtn.style.background = "#d9534f";
        removeBtn.textContent = "åˆ é™¤";
        removeBtn.onclick = (function(currentVisitDate) {
          return function() {
            removeVisitDate(currentVisitDate);
          };
        })(visit.date);

        row.appendChild(dateLabel);
        row.appendChild(timeSelect);
        row.appendChild(removeBtn);
        visitList.appendChild(row);
      });
    }

    function updateVisitTime(dateValue, timeValue) {
      selectedVisits = selectedVisits.map(function(visit) {
        if (visit.date === dateValue) {
          return Object.assign({}, visit, { time: timeValue });
        }
        return visit;
      });
    }

    function addVisitDate(dateValue) {
      if (selectedVisits.some(function(visit) { return visit.date === dateValue; })) {
        showMessage("âŒ è¯¥æ—¥æœŸå·²æ·»åŠ ", "error");
        return false;
      }

      var todayISO = getTodayISO();
      if (dateValue < todayISO) {
        showMessage("âŒ æœåŠ¡æ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸ", "error");
        return false;
      }

      selectedVisits.push({ date: dateValue, time: "" });
      selectedVisits.sort(function(a, b) { return a.date.localeCompare(b.date); });
      renderVisitList();
      return true;
    }

    function addSingleDate() {
      var dateInput = document.getElementById("date");
      var dateValue = dateInput.value;
      if (!dateValue) {
        showMessage("âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ—¥æœŸ", "error");
        return;
      }

      var todayISO = getTodayISO();
      if (dateValue < todayISO) {
        dateInput.classList.add("past-date");
        showMessage("âŒ æœåŠ¡æ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸ", "error");
        dateInput.value = "";
        dateInput.classList.remove("past-date");
        return;
      }

      var added = addVisitDate(dateValue);
      if (!added) {
        return;
      }

      dateInput.value = "";
      showMessage("âœ… æ—¥æœŸå·²æ·»åŠ ï¼Œè¯·ä¸ºè¯¥æ—¥æœŸé€‰æ‹©æ—¶é—´", "loading");
    }

    function addDateRange() {
      var startDate = document.getElementById("startDate").value;
      var endDate = document.getElementById("endDate").value;

      if (!startDate || !endDate) {
        showMessage("âŒ è¯·å…ˆé€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ", "error");
        return;
      }

      var todayISO = getTodayISO();
      if (startDate < todayISO) {
        document.getElementById("startDate").classList.add("past-date");
        showMessage("âŒ å¼€å§‹æ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸ", "error");
        document.getElementById("startDate").value = "";
        document.getElementById("startDate").classList.remove("past-date");
        return;
      }

      if (endDate < todayISO) {
        document.getElementById("endDate").classList.add("past-date");
        showMessage("âŒ ç»“æŸæ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸ", "error");
        document.getElementById("endDate").value = "";
        document.getElementById("endDate").classList.remove("past-date");
        return;
      }

      if (endDate < startDate) {
        showMessage("âŒ ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ", "error");
        return;
      }

      // æ™ºèƒ½åŒºé—´æ›´æ–°ï¼šé‡å æ—¥æœŸä¿ç•™åŸæ—¶é—´ï¼Œè¶…å‡ºèŒƒå›´è‡ªåŠ¨ç§»é™¤ï¼Œæ–°æ—¥æœŸè‡ªåŠ¨è¡¥å……
      var nextDateArray = [];
      var startParts = startDate.split("-");
      var endParts = endDate.split("-");
      var current = new Date(parseInt(startParts[0]), parseInt(startParts[1]) - 1, parseInt(startParts[2]));
      var end = new Date(parseInt(endParts[0]), parseInt(endParts[1]) - 1, parseInt(endParts[2]));

      while (current <= end) {
        var yyyy = current.getFullYear();
        var m = current.getMonth() + 1;
        var mm = (m < 10 ? "0" : "") + m;
        var d = current.getDate();
        var dd = (d < 10 ? "0" : "") + d;
        nextDateArray.push(yyyy + "-" + mm + "-" + dd);
        current.setDate(current.getDate() + 1);
      }

      var visitMap = {};
      selectedVisits.forEach(function(visit) {
        visitMap[visit.date] = visit;
      });
      var nextVisits = [];
      var addedCount = 0;
      nextDateArray.forEach(function(dateValue) {
        if (visitMap.hasOwnProperty(dateValue)) {
          nextVisits.push(visitMap[dateValue]);
        } else {
          nextVisits.push({ date: dateValue, time: "" });
          addedCount += 1;
        }
      });

      selectedVisits = nextVisits;
      renderVisitList();

      if (addedCount > 0) {
        showMessage("âœ… å·²æ·»åŠ  " + addedCount + " ä¸ªæ—¥æœŸï¼ˆ" + startDate + " è‡³ " + endDate + "ï¼‰ï¼Œè¯·ä¸ºæ¯ä¸ªæ—¥æœŸé€‰æ‹©æ—¶é—´", "loading");
      } else {
        showMessage("âœ… åŒºé—´å·²æ›´æ–°ï¼ˆ" + startDate + " è‡³ " + endDate + "ï¼‰ï¼Œå·²ä¿ç•™é‡å æ—¥æœŸçš„æ—¶é—´è®¾ç½®", "loading");
      }
    }

    function removeVisitDate(dateValue) {
      var newVisits = [];
      for (var i = 0; i < selectedVisits.length; i++) {
        if (selectedVisits[i].date !== dateValue) {
          newVisits.push(selectedVisits[i]);
        }
      }
      selectedVisits = newVisits;
      renderVisitList();
    }

    // è®¾ç½®æ—¥æœŸæœ€å°å€¼ï¼ˆè¿‡å»æ—¥æœŸä¸å¯é€‰ï¼‰
    function setDateMin() {
      var dateInput = document.getElementById("date");
      var startDateInput = document.getElementById("startDate");
      var endDateInput = document.getElementById("endDate");
      var todayISO = getTodayISO();
      dateInput.min = todayISO;
      startDateInput.min = todayISO;
      endDateInput.min = todayISO;
    }

    // æ¸…ç©ºè¡¨å•
    function clearForm() {
      document.getElementById("contactType").value = "";
      document.getElementById("contact").value = "";
      document.getElementById("ownerName").value = "";
      document.getElementById("prefecture").value = "";
      document.getElementById("city").value = "";
      document.getElementById("district").value = "";
      document.getElementById("addressDetail").value = "";
      document.getElementById("catName").value = "";
      document.getElementById("catAge").value = "";
      document.getElementById("bookingMode").value = "separate";
      document.getElementById("date").value = "";
      document.getElementById("startDate").value = "";
      document.getElementById("endDate").value = "";
      selectedVisits = [];
      renderVisitList();
      onBookingModeChange();
      document.getElementById("note").value = "";
      setDateMin();
      updateWard();
    }

    // éªŒè¯è¡¨å•
    function validateForm() {
      var contactType = document.getElementById("contactType").value;
      var contact = (document.getElementById("contact").value || "").trim();
      var ownerName = (document.getElementById("ownerName").value || "").trim();
      var prefecture = document.getElementById("prefecture").value;
      var city = document.getElementById("city").value;
      var district = document.getElementById("district").value;
      var addressDetail = (document.getElementById("addressDetail").value || "").trim();
      var catName = (document.getElementById("catName").value || "").trim();
      var catAge = (document.getElementById("catAge").value || "").trim();

      // å¿…å¡«æ£€æŸ¥
      if (!ownerName) return "âŒ å®¢æˆ·å§“åä¸èƒ½ä¸ºç©º";
      if (!contactType) return "âŒ è”ç³»æ–¹å¼ç±»å‹ä¸èƒ½ä¸ºç©º";
      if (!contact) return "âŒ è”ç³»æ–¹å¼ä¸èƒ½ä¸ºç©º";
      if (!prefecture) return "âŒ éƒ½é“åºœçœŒä¸èƒ½ä¸ºç©º";
      if (!city && areaData[prefecture].type === "city") return "âŒ å¸‚ä¸èƒ½ä¸ºç©º";
      if (!district) return "âŒ åŒº/å¸‚ä¸èƒ½ä¸ºç©º";
      if (!addressDetail) return "âŒ è¯¦ç»†åœ°å€ä¸èƒ½ä¸ºç©º";
      if (!catName) return "âŒ çŒ«å’ªåå­—ä¸èƒ½ä¸ºç©º";
      if (!catAge) return "âŒ çŒ«å’ªå¹´é¾„ä¸èƒ½ä¸ºç©º";
      if (selectedVisits.length === 0) return "âŒ è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæœåŠ¡æ—¥æœŸ";

      for (var i = 0; i < selectedVisits.length; i++) {
        var visit = selectedVisits[i];
        if (!visit.time) {
          return "âŒ è¯·ä¸ºæ—¥æœŸ " + visit.date + " é€‰æ‹©ä¸Šé—¨æ—¶é—´";
        }
      }

      // æ ¹æ®ç±»å‹éªŒè¯è”ç³»æ–¹å¼
      if (contactType === "ç”µè¯") {
        // æ—¥æœ¬ç”µè¯ï¼š
        // æ‰‹æœºï¼š090-1234-5678 æˆ– 09012345678ï¼ˆ11ä½ï¼‰
        // å›ºå®šç”µè¯ï¼š0456-12-3456 æˆ– 045612345ï¼ˆ10ä½ï¼‰
        var phoneDigits = contact.replace(/-/g, "");
        if (!/^0\d{9,10}$/.test(phoneDigits)) {
          return "âŒ ç”µè¯æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æ‰‹æœºï¼ˆ090-1234-5678ï¼‰æˆ–å›ºå®šç”µè¯ï¼ˆ0456-12-3456ï¼‰";
        }
      } else if (contactType === "é‚®ç®±") {
        // é‚®ç®±æ ¼å¼éªŒè¯
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(contact)) {
          return "âŒ é‚®ç®±æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€";
        }
      } else if (contactType === "å¾®ä¿¡") {
        // å¾®ä¿¡å·é•¿åº¦æ£€æŸ¥
        if (contact.length < 5 || contact.length > 20) {
          return "âŒ å¾®ä¿¡å·é•¿åº¦åº”åœ¨ 5-20 ä¸ªå­—ç¬¦ä¹‹é—´";
        }
      }

      // æ—¥æœŸæ£€æŸ¥ï¼ˆä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸï¼‰
      var todayISO = getTodayISO();
      for (var i = 0; i < selectedVisits.length; i++) {
        var visit = selectedVisits[i];
        if (visit.date < todayISO) {
          return "âŒ æœåŠ¡æ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸ";
        }
      }

      return null; // éªŒè¯é€šè¿‡
    }

    function submitAppointment() {
      // éªŒè¯è¡¨å•
      var validationError = validateForm();
      if (validationError) {
        showMessage(validationError, "error");
        return;
      }

      var submit_btn = document.getElementById("submitBtn");
      var prefecture = document.getElementById("prefecture").value;
      var city = document.getElementById("city").value;
      var district = document.getElementById("district").value;
      var addressDetail = (document.getElementById("addressDetail").value || "").trim();
      
      // æ ¹æ®éƒ½é“åºœçœŒç±»å‹ç»„åˆåœ°å€
      var address = "";
      var prefData = areaData[prefecture];
      if (prefData.type === "ward") {
        address = prefecture + district + " " + addressDetail;
      } else {
        address = prefecture + city + district + " " + addressDetail;
      }
      
      var datesList = [];
      var timeList = [];
      for (var i = 0; i < selectedVisits.length; i++) {
        datesList.push(selectedVisits[i].date);
        timeList.push(selectedVisits[i].date + " " + selectedVisits[i].time);
      }
      
      var data = {
        ownerName: (document.getElementById("ownerName").value || "").trim(),
        contactType: document.getElementById("contactType").value,
        contact: (document.getElementById("contact").value || "").trim(),
        address: address,
        catName: (document.getElementById("catName").value || "").trim(),
        catAge: (document.getElementById("catAge").value || "").trim(),
        date: selectedVisits[0].date,
        dates: datesList,
        visits: selectedVisits,
        time: timeList.join("ï¼›"),
        note: (document.getElementById("note").value || "").trim()
      };

      // ç¦ç”¨æäº¤æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
      submit_btn.disabled = true;
      showMessage("â³ æäº¤ä¸­ï¼Œè¯·ç¨å€™...", "loading");

      var makeRequest = function() {
        if (typeof fetch !== 'undefined') {
          fetch("/api/appointment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          })
          .then(function(res) {
            if (!res.ok) {
              return res.json().then(function(json) {
                throw new Error(json.message || "æäº¤å¤±è´¥");
              });
            }
            return res.json();
          })
          .then(function(result) {
            var reservationNumber = result && result.reservationNumber ? result.reservationNumber : "";
            if (reservationNumber) {
              alert("æäº¤æˆåŠŸï¼\né¢„çº¦å·ï¼š" + reservationNumber + "\nè¯·æˆªå›¾ä¿å­˜ï¼Œç”¨äºåç»­è‡ªåŠ©ä¿®æ”¹æˆ–å–æ¶ˆã€‚");
              showMessage("âœ… " + result.message + "ï¼Œé¢„çº¦å·ï¼š" + reservationNumber + "ï¼ˆè¯·æˆªå›¾ä¿å­˜ï¼‰", "success");
            } else {
              alert("æ‚¨å·²æäº¤ï¼Œè¯·ç­‰å¾…å·¥ä½œäººå‘˜è”ç³»");
              showMessage("âœ… " + result.message + "ï¼Œè¯·ç­‰å¾…å·¥ä½œäººå‘˜è”ç³»", "success");
            }
            submit_btn.disabled = false;
            
            // å°è¯•å‘é€ EmailJSï¼ˆéå¿…è¦ï¼‰
            try {
              if (typeof emailjs !== 'undefined' && emailjs.send) {
                emailjs.send("service_b91fibq", "template_63ko5qi", data).catch(function(err) {
                  console.warn("é‚®ä»¶å‘é€å¤±è´¥ï¼ˆä¸å½±å“æ•°æ®åº“ä¿å­˜ï¼‰", err);
                });
              }
            } catch(emailErr) {
              console.warn("é‚®ä»¶å‘é€å¤±è´¥ï¼ˆä¸å½±å“æ•°æ®åº“ä¿å­˜ï¼‰", emailErr);
            }
          })
          .catch(function(e) {
            console.error("âŒ é”™è¯¯ï¼š", e);
            var errMsg = e && e.message ? e.message : "æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•";
            showMessage("âŒ " + errMsg, "error");
            submit_btn.disabled = false;
          });
        } else {
          // IE9+: XMLHttpRequest
          var xhr = new XMLHttpRequest();
          xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
              submit_btn.disabled = false;
              try {
                var result = JSON.parse(xhr.responseText);
                if (xhr.status === 200 || xhr.status === 201) {
                  var reservationNumber = result && result.reservationNumber ? result.reservationNumber : "";
                  if (reservationNumber) {
                    alert("æäº¤æˆåŠŸï¼\né¢„çº¦å·ï¼š" + reservationNumber + "\nè¯·æˆªå›¾ä¿å­˜ï¼Œç”¨äºåç»­è‡ªåŠ©ä¿®æ”¹æˆ–å–æ¶ˆã€‚");
                    showMessage("âœ… " + result.message + "ï¼Œé¢„çº¦å·ï¼š" + reservationNumber + "ï¼ˆè¯·æˆªå›¾ä¿å­˜ï¼‰", "success");
                  } else {
                    alert("æ‚¨å·²æäº¤ï¼Œè¯·ç­‰å¾…å·¥ä½œäººå‘˜è”ç³»");
                    showMessage("âœ… " + result.message + "ï¼Œè¯·ç­‰å¾…å·¥ä½œäººå‘˜è”ç³»", "success");
                  }
                  
                  // å°è¯•å‘é€ EmailJSï¼ˆéå¿…è¦ï¼‰
                  try {
                    if (typeof emailjs !== 'undefined' && emailjs.send) {
                      emailjs.send("service_b91fibq", "template_63ko5qi", data).catch(function(err) {
                        console.warn("é‚®ä»¶å‘é€å¤±è´¥ï¼ˆä¸å½±å“æ•°æ®åº“ä¿å­˜ï¼‰", err);
                      });
                    }
                  } catch(emailErr) {
                    console.warn("é‚®ä»¶å‘é€å¤±è´¥ï¼ˆä¸å½±å“æ•°æ®åº“ä¿å­˜ï¼‰", emailErr);
                  }
                } else {
                  var errMsg = result.message || "æäº¤å¤±è´¥";
                  showMessage("âŒ " + errMsg, "error");
                }
              } catch(e) {
                showMessage("âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•", "error");
              }
            }
          };
          xhr.onerror = function() {
            submit_btn.disabled = false;
            showMessage("âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥", "error");
          };
          xhr.ontimeout = function() {
            submit_btn.disabled = false;
            showMessage("âŒ è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•", "error");
          };
          xhr.open("POST", "/api/appointment");
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.timeout = 30000;
          xhr.send(JSON.stringify(data));
        }
      };
      
      makeRequest();
    }

    setDateMin();
    onBookingModeChange();

    // å®æ—¶ç›‘å¬æ—¥æœŸè¾“å…¥æ¡†ï¼Œç¦æ­¢è¿‡å»æ—¥æœŸ
    document.getElementById("date").addEventListener("change", function() {
      var todayISO = getTodayISO();
      if (this.value && this.value < todayISO) {
        this.classList.add("past-date");
        showMessage("âŒ æœåŠ¡æ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸï¼Œè¯·é‡æ–°é€‰æ‹©", "error");
        this.value = "";
        this.classList.remove("past-date");
      } else {
        this.classList.remove("past-date");
      }
    }, false);

    document.getElementById("startDate").addEventListener("change", function() {
      var todayISO = getTodayISO();
      if (this.value && this.value < todayISO) {
        this.classList.add("past-date");
        showMessage("âŒ å¼€å§‹æ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸï¼Œè¯·é‡æ–°é€‰æ‹©", "error");
        this.value = "";
        this.classList.remove("past-date");
      } else {
        this.classList.remove("past-date");
      }
    }, false);

    document.getElementById("endDate").addEventListener("change", function() {
      var todayISO = getTodayISO();
      if (this.value && this.value < todayISO) {
        this.classList.add("past-date");
        showMessage("âŒ ç»“æŸæ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸï¼Œè¯·é‡æ–°é€‰æ‹©", "error");
        this.value = "";
        this.classList.remove("past-date");
      } else {
        this.classList.remove("past-date");
      }
    }, false);
  </script>
</body>
</html>