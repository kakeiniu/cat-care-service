<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>çŒ«å’ªä¸Šé—¨çœ‹æŠ¤é¢„çº¦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui;
      background: #f5f5f5;
      padding: 20px;
    }
    .box {
      max-width: 520px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    .required { color: red; }
    input, textarea, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #4caf50;
      box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
    }
    button {
      width: 100%;
      margin-top: 20px;
      padding: 10px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: background 0.3s;
    }
    button:hover:not(:disabled) {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .message {
      margin-top: 15px;
      padding: 12px;
      border-radius: 4px;
      display: none;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .loading {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .date-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 5px;
    }
    .date-row input {
      flex: 1;
      margin-top: 0;
    }
    .small-btn {
      width: auto;
      margin-top: 0;
      padding: 8px 12px;
      font-size: 14px;
      white-space: nowrap;
    }
    .date-list {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .date-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #eef7ef;
      border: 1px solid #cfe8d1;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 13px;
    }
    .date-tag button {
      width: auto;
      margin-top: 0;
      padding: 2px 6px;
      font-size: 12px;
      background: #d9534f;
      border-radius: 999px;
    }
    .date-help {
      margin-top: 6px;
      font-size: 12px;
      color: #666;
    }
    .visit-list {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .visit-row {
      display: flex;
      gap: 8px;
      align-items: center;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 8px;
      background: #fafafa;
    }
    .visit-date {
      min-width: 120px;
      font-weight: bold;
      color: #333;
    }
    .visit-time {
      flex: 1;
      margin-top: 0;
    }
  </style>
</head>

<body>
  <div class="box">
    <h2>ğŸ± çŒ«å’ªä¸Šé—¨çœ‹æŠ¤é¢„çº¦</h2>

    <label>è”ç³»æ–¹å¼ç±»å‹ <span class="required">*</span></label>
    <select id="contactType">
      <option value="">-- è¯·é€‰æ‹© --</option>
      <option value="ç”µè¯">ç”µè¯</option>
      <option value="å¾®ä¿¡">å¾®ä¿¡</option>
      <option value="é‚®ç®±">é‚®ç®±</option>
    </select>

    <label>è”ç³»æ–¹å¼ <span class="required">*</span></label>
    <input id="contact" placeholder="æ‰‹æœºï¼š090-1234-5678ï¼›å›ºå®šç”µè¯ï¼š0456-12-3456ï¼›é‚®ç®±ï¼šxxx@example.comï¼›å¾®ä¿¡ï¼šxxxxxxx" />

    <label>ä¸Šé—¨åœ°åŒºï¼ˆéƒ½é“åºœçœŒï¼‰ <span class="required">*</span></label>
    <select id="prefecture" onchange="updateWard()">
      <option value="">-- è¯·é€‰æ‹©éƒ½é“åºœçœŒ --</option>
      <option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option>
      <option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option>
      <option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option>
      <option value="åƒè‘‰çœŒ">åƒè‘‰çœŒ</option>
    </select>

    <div id="citySection" style="display: none;">
      <label>ä¸Šé—¨åœ°åŒºï¼ˆå¸‚ï¼‰ <span class="required">*</span></label>
      <select id="city" onchange="updateDistrict()">
        <option value="">-- å…ˆé€‰æ‹©éƒ½é“åºœçœŒ --</option>
      </select>
    </div>

    <label>ä¸Šé—¨åœ°åŒºï¼ˆåŒºï¼‰ <span class="required">*</span></label>
    <select id="district">
      <option value="">-- å…ˆé€‰æ‹©å¸‚ --</option>
    </select>

    <label>è¯¦ç»†åœ°å€ï¼ˆä»å‡ ä¸ç›®åå¼€å§‹è¾“å…¥ï¼Œä¾‹ï¼š1-2-3 â—‹â—‹ãƒ“ãƒ«3éšï¼‰ <span class="required">*</span></label>
    <input id="addressDetail" placeholder="ä¾‹å¦‚ï¼š1-2-3ã€1ç•ªåœ°1å·ã€â—‹â—‹ãƒ“ãƒ«3éšï¼ˆå‡ ä¸ç›®å‰é¢çš„å†…å®¹è¯·åœ¨ä¸Šæ–¹ä¸‹æ‹‰é€‰æ‹©ï¼‰" />

    <label>çŒ«å’ªåå­— <span class="required">*</span></label>
    <input id="catName" placeholder="è¯·è¾“å…¥çŒ«å’ªåå­—" />

    <label>çŒ«å’ªå¹´é¾„ <span class="required">*</span></label>
    <input id="catAge" placeholder="ä¾‹å¦‚ï¼š3å²" />

    <label>é¢„çº¦æ–¹å¼ <span class="required">*</span></label>
    <select id="bookingMode" onchange="onBookingModeChange()">
      <option value="separate">åˆ†å¼€æ—¥æœŸï¼ˆä¸è¿ç»­ï¼‰</option>
      <option value="range">ä¸€æ®µåŒºé—´ï¼ˆè¿ç»­ï¼‰</option>
    </select>

    <div id="separateDateSection">
      <label>æœåŠ¡æ—¥æœŸï¼ˆåˆ†å¼€æ·»åŠ ï¼‰ <span class="required">*</span></label>
      <div class="date-row">
        <input type="date" id="date" />
        <button type="button" class="small-btn" onclick="addSingleDate()">æ·»åŠ æ—¥æœŸ</button>
      </div>
    </div>

    <div id="rangeDateSection" style="display: none;">
      <label>æœåŠ¡æ—¥æœŸåŒºé—´ <span class="required">*</span></label>
      <div class="date-row">
        <input type="date" id="startDate" />
        <input type="date" id="endDate" />
        <button type="button" class="small-btn" onclick="addDateRange()">æ·»åŠ åŒºé—´</button>
      </div>
    </div>

    <div class="date-help">æ·»åŠ åè¯·ä¸ºæ¯ä¸ªæ—¥æœŸåˆ†åˆ«é€‰æ‹©ä¸Šé—¨æ—¶é—´ï¼›åŒºé—´ä¿®æ”¹æ—¶ä¼šä¿ç•™é‡å æ—¥æœŸçš„æ—¶é—´è®¾ç½®</div>
    <div id="visitList" class="visit-list"></div>

    <label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
    <textarea id="note" placeholder="ä¾‹å¦‚ï¼šçŒ«å’ªæ€§æ ¼ã€ç‰¹æ®Šéœ€æ±‚ç­‰"></textarea>

    <button id="submitBtn" onclick="submitAppointment()">æäº¤é¢„çº¦</button>

    <div id="message" class="message"></div>
  </div>

  <!-- âœ… æ­£ç¡®çš„ EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

  <!-- âœ… åˆå§‹åŒ– -->
  <script>
    emailjs.init("MMb0p4BWJBxDK-Sgk");
  </script>

  <!-- âœ… ä¸šåŠ¡é€»è¾‘ -->
  <script>
    // çº§è”èœå•æ•°æ®ï¼ˆ3å¿å…¨å¸‚ + ä¸œäº¬23åŒºï¼‰
    const areaData = {
      "æ±äº¬éƒ½": {
        type: "ward",
        items: [
          "åƒä»£ç”°åŒº", "ä¸­å¤®åŒº", "æ¸¯åŒº", "æ–°å®¿åŒº", "æ–‡äº¬åŒº", "å°æ±åŒº", "å¢¨ç”°åŒº", "æ±Ÿæ±åŒº",
          "å“å·åŒº", "ç›®é»’åŒº", "å¤§ç”°åŒº", "ä¸–ç”°è°·åŒº", "æ¸‹è°·åŒº", "ä¸­é‡åŒº", "æ‰ä¸¦åŒº", "è±Šå³¶åŒº",
          "åŒ—åŒº", "è’å·åŒº", "æ¿æ©‹åŒº", "ç·´é¦¬åŒº", "è¶³ç«‹åŒº", "è‘›é£¾åŒº", "æ±Ÿæˆ¸å·åŒº"
        ]
      },
      "åŸ¼ç‰çœŒ": {
        type: "city",
        items: [
          "ã•ã„ãŸã¾å¸‚", "å·è¶Šå¸‚", "ç†Šè°·å¸‚", "å·å£å¸‚", "è¡Œç”°å¸‚", "ç§©çˆ¶å¸‚", "æ‰€æ²¢å¸‚", "é£¯èƒ½å¸‚",
          "åŠ é ˆå¸‚", "æœ¬åº„å¸‚", "æ±æ¾å±±å¸‚", "æ˜¥æ—¥éƒ¨å¸‚", "ç‹­å±±å¸‚", "ç¾½ç”Ÿå¸‚", "é´»å·£å¸‚", "æ·±è°·å¸‚",
          "ä¸Šå°¾å¸‚", "è‰åŠ å¸‚", "è¶Šè°·å¸‚", "è•¨å¸‚", "æˆ¸ç”°å¸‚", "å…¥é–“å¸‚", "æœéœå¸‚", "å¿—æœ¨å¸‚",
          "å’Œå…‰å¸‚", "æ–°åº§å¸‚", "æ¡¶å·å¸‚", "ä¹…å–œå¸‚", "åŒ—æœ¬å¸‚", "å…«æ½®å¸‚", "å¯Œå£«è¦‹å¸‚", "ä¸‰éƒ·å¸‚",
          "è“®ç”°å¸‚", "å‚æˆ¸å¸‚", "å¹¸æ‰‹å¸‚", "é¶´ãƒ¶å³¶å¸‚", "æ—¥é«˜å¸‚", "å‰å·å¸‚", "ãµã˜ã¿é‡å¸‚", "ç™½å²¡å¸‚"
        ]
      },
      "ç¥å¥ˆå·çœŒ": {
        type: "city",
        items: [
          "æ¨ªæµœå¸‚", "å·å´å¸‚", "ç›¸æ¨¡åŸå¸‚", "æ¨ªé ˆè³€å¸‚", "å¹³å¡šå¸‚", "éŒå€‰å¸‚", "è—¤æ²¢å¸‚", "å°ç”°åŸå¸‚",
          "èŒ…ãƒ¶å´å¸‚", "é€—å­å¸‚", "ä¸‰æµ¦å¸‚", "ç§¦é‡å¸‚", "åšæœ¨å¸‚", "å¤§å’Œå¸‚", "ä¼Šå‹¢åŸå¸‚", "æµ·è€åå¸‚",
          "åº§é–“å¸‚", "å—è¶³æŸ„å¸‚", "ç¶¾ç€¬å¸‚"
        ]
      },
      "åƒè‘‰çœŒ": {
        type: "city",
        items: [
          "åƒè‘‰å¸‚", "éŠšå­å¸‚", "å¸‚å·å¸‚", "èˆ¹æ©‹å¸‚", "é¤¨å±±å¸‚", "æœ¨æ›´æ´¥å¸‚", "æ¾æˆ¸å¸‚", "é‡ç”°å¸‚",
          "èŒ‚åŸå¸‚", "æˆç”°å¸‚", "ä½å€‰å¸‚", "æ±é‡‘å¸‚", "æ—­å¸‚", "ç¿’å¿—é‡å¸‚", "æŸå¸‚", "å‹æµ¦å¸‚",
          "å¸‚åŸå¸‚", "æµå±±å¸‚", "å…«åƒä»£å¸‚", "æˆ‘å­«å­å¸‚", "é´¨å·å¸‚", "éŒã‚±è°·å¸‚", "å›æ´¥å¸‚", "å¯Œæ´¥å¸‚",
          "æµ¦å®‰å¸‚", "å››è¡—é“å¸‚", "è¢–ã‚±æµ¦å¸‚", "å…«è¡—å¸‚", "å°è¥¿å¸‚", "ç™½äº•å¸‚", "å¯Œé‡Œå¸‚", "å—æˆ¿ç·å¸‚",
          "åŒç‘³å¸‚", "é¦™å–å¸‚", "å±±æ­¦å¸‚", "ã„ã™ã¿å¸‚", "å¤§ç¶²ç™½é‡Œå¸‚"
        ]
      }
    };

    const TOWN_API = "https://geoapi.heartrails.com/api/json?method=getTowns";
    const TIME_OPTIONS = [
      "ä¸Šåˆï¼ˆ9:00 - 12:00ï¼‰",
      "ä¸‹åˆï¼ˆ13:00 - 17:00ï¼‰",
      "æ™šä¸Šï¼ˆ18:00 - 21:00ï¼‰"
    ];
    let selectedVisits = [];

    // æ›´æ–°å¸‚/åŒºçš„çº§è”èœå•å‡½æ•°
    function updateWard() {
      const prefecture = document.getElementById("prefecture").value;
      const citySection = document.getElementById("citySection");
      const citySelect = document.getElementById("city");
      const districtSelect = document.getElementById("district");
      
      // æ¸…ç©ºå¸‚å’ŒåŒº
      citySelect.innerHTML = '';
      districtSelect.innerHTML = '';
      
      if (!prefecture) {
        citySelect.innerHTML = '<option value="">-- å…ˆé€‰æ‹©éƒ½é“åºœçœŒ --</option>';
        districtSelect.innerHTML = '<option value="">-- å…ˆé€‰æ‹©å¸‚ --</option>';
        citySection.style.display = 'none';
        return;
      }
      
      const prefData = areaData[prefecture];
      if (prefData.type === "ward") {
        // ä¸œäº¬ç‰¹æ®Šå¤„ç†ï¼šç›´æ¥æ˜¾ç¤ºåŒºï¼Œéšè—å¸‚é€‰æ‹©
        citySection.style.display = 'none';
        citySelect.value = '';
        districtSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©' + prefecture + 'çš„åŒº --</option>';
        prefData.items.forEach(ward => {
          const option = document.createElement("option");
          option.value = prefecture + ward;
          option.textContent = ward;
          districtSelect.appendChild(option);
        });
      } else {
        // å…¶ä»–å¿ï¼šæ˜¾ç¤ºå¸‚é€‰æ‹©ï¼Œç„¶åæŒ‰å¸‚åŠ¨æ€åŠ è½½åŒº/ç”ºåŸŸ
        citySection.style.display = 'block';
        citySelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å¸‚ --</option>';
        districtSelect.innerHTML = '<option value="">-- å…ˆé€‰æ‹©å¸‚ --</option>';
        prefData.items.forEach(city => {
          const option = document.createElement("option");
          option.value = city;
          option.textContent = city;
          citySelect.appendChild(option);
        });
      }
    }

    // æ›´æ–°åŒºçš„çº§è”èœå•å‡½æ•°
    async function updateDistrict() {
      const prefecture = document.getElementById("prefecture").value;
      const city = document.getElementById("city").value;
      const districtSelect = document.getElementById("district");
      
      districtSelect.innerHTML = '';
      
      if (!prefecture || !city) {
        districtSelect.innerHTML = '<option value="">-- å…ˆé€‰æ‹©å¸‚ --</option>';
        return;
      }
      
      districtSelect.innerHTML = '<option value="">-- æ­£åœ¨åŠ è½½åŒº/ç”ºåŸŸ... --</option>';

      try {
        const url = `${TOWN_API}&prefecture=${encodeURIComponent(prefecture)}&city=${encodeURIComponent(city)}`;
        const res = await fetch(url);
        const json = await res.json();
        const locations = json?.response?.location || [];
        const towns = [...new Set(locations.map(item => item.town).filter(Boolean))];

        districtSelect.innerHTML = '';
        if (towns.length === 0) {
          districtSelect.innerHTML = '<option value="' + city + '">' + city + 'ï¼ˆå…¨åŸŸï¼‰</option>';
          districtSelect.value = city + 'ï¼ˆå…¨åŸŸï¼‰';
          return;
        }

        districtSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©' + city + 'çš„åŒº/ç”ºåŸŸ --</option>';
        towns.forEach(town => {
          const option = document.createElement("option");
          option.value = town;
          option.textContent = town;
          districtSelect.appendChild(option);
        });
      } catch (error) {
        districtSelect.innerHTML = '<option value="' + city + '">' + city + 'ï¼ˆå…¨åŸŸï¼‰</option>';
        districtSelect.value = city + 'ï¼ˆå…¨åŸŸï¼‰';
      }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(text, type) {
      const msg = document.getElementById("message");
      msg.textContent = text;
      msg.className = `message ${type}`;
      msg.style.display = "block";
      if (type === "success") {
        setTimeout(() => {
          msg.style.display = "none";
          clearForm();
        }, 3000);
      }
    }

    function getTodayISO() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function onBookingModeChange() {
      const mode = document.getElementById("bookingMode").value;
      const separateSection = document.getElementById("separateDateSection");
      const rangeSection = document.getElementById("rangeDateSection");
      if (mode === "range") {
        separateSection.style.display = "none";
        rangeSection.style.display = "block";
      } else {
        separateSection.style.display = "block";
        rangeSection.style.display = "none";
      }
    }

    function renderVisitList() {
      const visitList = document.getElementById("visitList");
      visitList.innerHTML = "";

      selectedVisits.forEach(visit => {
        const row = document.createElement("div");
        row.className = "visit-row";

        const dateLabel = document.createElement("span");
        dateLabel.className = "visit-date";
        dateLabel.textContent = visit.date;

        const timeSelect = document.createElement("select");
        timeSelect.className = "visit-time";
        timeSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©ä¸Šé—¨æ—¶é—´ --</option>';
        TIME_OPTIONS.forEach(timeText => {
          const option = document.createElement("option");
          option.value = timeText;
          option.textContent = timeText;
          if (visit.time === timeText) {
            option.selected = true;
          }
          timeSelect.appendChild(option);
        });
        timeSelect.onchange = (event) => {
          updateVisitTime(visit.date, event.target.value);
        };

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "small-btn";
        removeBtn.style.background = "#d9534f";
        removeBtn.textContent = "åˆ é™¤";
        removeBtn.onclick = () => removeVisitDate(visit.date);

        row.appendChild(dateLabel);
        row.appendChild(timeSelect);
        row.appendChild(removeBtn);
        visitList.appendChild(row);
      });
    }

    function updateVisitTime(dateValue, timeValue) {
      selectedVisits = selectedVisits.map(visit =>
        visit.date === dateValue ? { ...visit, time: timeValue } : visit
      );
    }

    function addVisitDate(dateValue) {
      if (selectedVisits.some(visit => visit.date === dateValue)) {
        showMessage("âŒ è¯¥æ—¥æœŸå·²æ·»åŠ ", "error");
        return false;
      }

      const todayISO = getTodayISO();
      if (dateValue < todayISO) {
        showMessage("âŒ æœåŠ¡æ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸ", "error");
        return false;
      }

      selectedVisits.push({ date: dateValue, time: "" });
      selectedVisits.sort((a, b) => a.date.localeCompare(b.date));
      renderVisitList();
      return true;
    }

    function addSingleDate() {
      const dateInput = document.getElementById("date");
      const dateValue = dateInput.value;
      if (!dateValue) {
        showMessage("âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ—¥æœŸ", "error");
        return;
      }

      const added = addVisitDate(dateValue);
      if (!added) {
        return;
      }

      dateInput.value = "";
      showMessage("âœ… æ—¥æœŸå·²æ·»åŠ ï¼Œè¯·ä¸ºè¯¥æ—¥æœŸé€‰æ‹©æ—¶é—´", "loading");
    }

    function addDateRange() {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;

      if (!startDate || !endDate) {
        showMessage("âŒ è¯·å…ˆé€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ", "error");
        return;
      }

      if (endDate < startDate) {
        showMessage("âŒ ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ", "error");
        return;
      }

      // æ™ºèƒ½åŒºé—´æ›´æ–°ï¼šé‡å æ—¥æœŸä¿ç•™åŸæ—¶é—´ï¼Œè¶…å‡ºèŒƒå›´è‡ªåŠ¨ç§»é™¤ï¼Œæ–°æ—¥æœŸè‡ªåŠ¨è¡¥å……
      const nextDateSet = new Set();
      let current = new Date(startDate + "T00:00:00");
      const end = new Date(endDate + "T00:00:00");

      while (current <= end) {
        const yyyy = current.getFullYear();
        const mm = String(current.getMonth() + 1).padStart(2, "0");
        const dd = String(current.getDate()).padStart(2, "0");
        nextDateSet.add(`${yyyy}-${mm}-${dd}`);
        current.setDate(current.getDate() + 1);
      }

      const visitMap = new Map(selectedVisits.map(visit => [visit.date, visit]));
      const nextVisits = [];
      let addedCount = 0;

      Array.from(nextDateSet).sort().forEach(dateValue => {
        if (visitMap.has(dateValue)) {
          nextVisits.push(visitMap.get(dateValue));
        } else {
          nextVisits.push({ date: dateValue, time: "" });
          addedCount += 1;
        }
      });

      selectedVisits = nextVisits;
      renderVisitList();

      if (addedCount > 0) {
        showMessage(`âœ… åŒºé—´å·²æ›´æ–°ï¼Œæ–°å¢ ${addedCount} ä¸ªæ—¥æœŸï¼Œè¯·è¡¥å……æ—¶é—´`, "loading");
      } else {
        showMessage("âœ… åŒºé—´å·²æ›´æ–°ï¼Œå·²ä¿ç•™é‡å æ—¥æœŸçš„æ—¶é—´è®¾ç½®", "loading");
      }
    }

    function removeVisitDate(dateValue) {
      selectedVisits = selectedVisits.filter(visit => visit.date !== dateValue);
      renderVisitList();
    }

    // è®¾ç½®æ—¥æœŸæœ€å°å€¼ï¼ˆè¿‡å»æ—¥æœŸä¸å¯é€‰ï¼‰
    function setDateMin() {
      const dateInput = document.getElementById("date");
      const startDateInput = document.getElementById("startDate");
      const endDateInput = document.getElementById("endDate");
      dateInput.min = getTodayISO();
      startDateInput.min = getTodayISO();
      endDateInput.min = getTodayISO();
    }

    // æ¸…ç©ºè¡¨å•
    function clearForm() {
      document.getElementById("contactType").value = "";
      document.getElementById("contact").value = "";
      document.getElementById("prefecture").value = "";
      document.getElementById("city").value = "";
      document.getElementById("district").value = "";
      document.getElementById("addressDetail").value = "";
      document.getElementById("catName").value = "";
      document.getElementById("catAge").value = "";
      document.getElementById("bookingMode").value = "separate";
      document.getElementById("date").value = "";
      document.getElementById("startDate").value = "";
      document.getElementById("endDate").value = "";
      selectedVisits = [];
      renderVisitList();
      onBookingModeChange();
      document.getElementById("note").value = "";
      setDateMin();
      updateWard();
    }

    // éªŒè¯è¡¨å•
    function validateForm() {
      const contactType = document.getElementById("contactType").value;
      const contact = document.getElementById("contact").value.trim();
      const prefecture = document.getElementById("prefecture").value;
      const city = document.getElementById("city").value;
      const district = document.getElementById("district").value;
      const addressDetail = document.getElementById("addressDetail").value.trim();
      const catName = document.getElementById("catName").value.trim();
      const catAge = document.getElementById("catAge").value.trim();

      // å¿…å¡«æ£€æŸ¥
      if (!contactType) return "âŒ è”ç³»æ–¹å¼ç±»å‹ä¸èƒ½ä¸ºç©º";
      if (!contact) return "âŒ è”ç³»æ–¹å¼ä¸èƒ½ä¸ºç©º";
      if (!prefecture) return "âŒ éƒ½é“åºœçœŒä¸èƒ½ä¸ºç©º";
      if (!city && areaData[prefecture].type === "city") return "âŒ å¸‚ä¸èƒ½ä¸ºç©º";
      if (!district) return "âŒ åŒº/å¸‚ä¸èƒ½ä¸ºç©º";
      if (!addressDetail) return "âŒ è¯¦ç»†åœ°å€ä¸èƒ½ä¸ºç©º";
      if (!catName) return "âŒ çŒ«å’ªåå­—ä¸èƒ½ä¸ºç©º";
      if (!catAge) return "âŒ çŒ«å’ªå¹´é¾„ä¸èƒ½ä¸ºç©º";
      if (selectedVisits.length === 0) return "âŒ è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæœåŠ¡æ—¥æœŸ";

      for (const visit of selectedVisits) {
        if (!visit.time) {
          return `âŒ è¯·ä¸ºæ—¥æœŸ ${visit.date} é€‰æ‹©ä¸Šé—¨æ—¶é—´`;
        }
      }

      // æ ¹æ®ç±»å‹éªŒè¯è”ç³»æ–¹å¼
      if (contactType === "ç”µè¯") {
        // æ—¥æœ¬ç”µè¯ï¼š
        // æ‰‹æœºï¼š090-1234-5678 æˆ– 09012345678ï¼ˆ11ä½ï¼‰
        // å›ºå®šç”µè¯ï¼š0456-12-3456 æˆ– 045612345ï¼ˆ10ä½ï¼‰
        const phoneDigits = contact.replace(/-/g, "");
        if (!/^0\d{9,10}$/.test(phoneDigits)) {
          return "âŒ ç”µè¯æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æ‰‹æœºï¼ˆ090-1234-5678ï¼‰æˆ–å›ºå®šç”µè¯ï¼ˆ0456-12-3456ï¼‰";
        }
      } else if (contactType === "é‚®ç®±") {
        // é‚®ç®±æ ¼å¼éªŒè¯
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(contact)) {
          return "âŒ é‚®ç®±æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€";
        }
      } else if (contactType === "å¾®ä¿¡") {
        // å¾®ä¿¡å·é•¿åº¦æ£€æŸ¥
        if (contact.length < 5 || contact.length > 20) {
          return "âŒ å¾®ä¿¡å·é•¿åº¦åº”åœ¨ 5-20 ä¸ªå­—ç¬¦ä¹‹é—´";
        }
      }

      // æ—¥æœŸæ£€æŸ¥ï¼ˆä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸï¼‰
      const todayISO = getTodayISO();
      for (const visit of selectedVisits) {
        if (visit.date < todayISO) {
          return "âŒ æœåŠ¡æ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸ";
        }
      }

      return null; // éªŒè¯é€šè¿‡
    }

    async function submitAppointment() {
      // éªŒè¯è¡¨å•
      const validationError = validateForm();
      if (validationError) {
        showMessage(validationError, "error");
        return;
      }

      const submit_btn = document.getElementById("submitBtn");
      const prefecture = document.getElementById("prefecture").value;
      const city = document.getElementById("city").value;
      const district = document.getElementById("district").value;
      const addressDetail = document.getElementById("addressDetail").value.trim();
      
      // æ ¹æ®éƒ½é“åºœçœŒç±»å‹ç»„åˆåœ°å€
      let address = "";
      const prefData = areaData[prefecture];
      if (prefData.type === "ward") {
        address = prefecture + district + " " + addressDetail;
      } else {
        address = prefecture + city + district + " " + addressDetail;
      }
      
      const data = {
        contactType: document.getElementById("contactType").value,
        contact: document.getElementById("contact").value.trim(),
        address: address,
        catName: document.getElementById("catName").value.trim(),
        catAge: document.getElementById("catAge").value.trim(),
        date: selectedVisits[0].date,
        dates: selectedVisits.map(visit => visit.date),
        visits: selectedVisits,
        time: selectedVisits.map(visit => `${visit.date} ${visit.time}`).join("ï¼›"),
        note: document.getElementById("note").value.trim()
      };

      // ç¦ç”¨æäº¤æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
      submit_btn.disabled = true;
      showMessage("â³ æäº¤ä¸­ï¼Œè¯·ç¨å€™...", "loading");

      try {
        // å‘é€åˆ°åç«¯
        const res = await fetch("/api/appointment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        const result = await res.json();

        if (!res.ok) {
          throw new Error(result.message || "æäº¤å¤±è´¥");
        }

        // åŒæ—¶å‘é€ EmailJSï¼ˆéå¿…è¦ï¼‰
        try {
          await emailjs.send(
            "service_b91fibq",
            "template_63ko5qi",
            data
          );
        } catch (emailErr) {
          console.warn("é‚®ä»¶å‘é€å¤±è´¥ï¼ˆä¸å½±å“æ•°æ®åº“ä¿å­˜ï¼‰ï¼š", emailErr);
        }

        alert("æ‚¨å·²æäº¤ï¼Œè¯·ç­‰å¾…å·¥ä½œäººå‘˜è”ç³»");
        showMessage("âœ… " + result.message + "ï¼Œè¯·ç­‰å¾…å·¥ä½œäººå‘˜è”ç³»", "success");
      } catch (e) {
        console.error("âŒ é”™è¯¯ï¼š", e);
        showMessage("âŒ " + (e.message || "æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•"), "error");
      } finally {
        submit_btn.disabled = false;
      }
    }

    setDateMin();
    onBookingModeChange();
  </script>
</body>
</html>