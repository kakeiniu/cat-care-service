<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>çŒ«å’ªä¸Šé—¨çœ‹æŠ¤é¢„çº¦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: linear-gradient(135deg, #FFF1F4 0%, #FFE1E8 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .box {
      max-width: 520px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(255, 182, 193, 0.15);
    }
    h2 {
      color: #333;
      text-align: center;
      font-size: 24px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #FFC7D2;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
      color: #555;
    }
    .required { color: #E48A9E; }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 2px solid #e5e5e5;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #FFC7D2;
      box-shadow: 0 0 8px rgba(255, 182, 193, 0.25);
    }
    input:disabled, input.past-date {
      background-color: #e8e8e8 !important;
      color: #999 !important;
      cursor: not-allowed !important;
      opacity: 0.6;
    }
    button {
      width: 100%;
      margin-top: 20px;
      padding: 12px;
      background: linear-gradient(135deg, #FFC7D2 0%, #FFB9C8 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(255, 182, 193, 0.25);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    button:hover:not(:disabled) {
      background: linear-gradient(135deg, #FFB9C8 0%, #FFA9BD 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 182, 193, 0.3);
    }
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
    }
    .message {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      display: none;
    }
    .success {
      background: #FFF4F7;
      color: #B96A80;
      border: 2px solid #FFD1DB;
    }
    .error {
      background: #FFF1F3;
      color: #C96A7B;
      border: 2px solid #FF9EAD;
    }
    .loading {
      background: #FFF7FA;
      color: #B96A80;
      border: 2px solid #FFD1DB;
    }
    .date-row {
      display: -webkit-flex;
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 5px;
    }
    .date-row input {
      flex: 1;
      margin-top: 0;
    }
    .small-btn {
      width: auto;
      margin-top: 0;
      padding: 8px 15px;
      font-size: 14px;
      white-space: nowrap;
      min-height: 38px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .date-list {
      margin-top: 8px;
      display: -webkit-flex;
      display: flex;
      -webkit-flex-wrap: wrap;
      flex-wrap: wrap;
      gap: 8px;
    }
    .date-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #FFEFF3;
      border: 2px solid #FFD1DB;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 13px;
      color: #B96A80;
    }
    .date-tag button {
      width: auto;
      margin-top: 0;
      padding: 2px 8px;
      font-size: 12px;
      background: #FF9EAD;
      border-radius: 999px;
      box-shadow: none;
      min-height: 28px;
      -webkit-tap-highlight-color: transparent;
    }
    .date-tag button:hover {
      background: #F18498;
    }
    .date-tag button:active {
      transform: scale(0.95);
    }
    .date-help {
      margin-top: 8px;
      font-size: 12px;
      color: #666;
      line-height: 1.5;
    }
    .date-help a {
      color: #F093A8;
      text-decoration: none;
      font-weight: bold;
    }
    .date-help a:hover {
      color: #E87D96;
      text-decoration: underline;
    }
    .visit-list {
      margin-top: 8px;
      display: -webkit-flex;
      display: flex;
      -webkit-flex-direction: column;
      flex-direction: column;
      gap: 8px;
    }
    .visit-row {
      display: -webkit-flex;
      display: flex;
      gap: 8px;
      -webkit-align-items: center;
      align-items: center;
      border: 2px solid #FFD1DB;
      border-radius: 8px;
      padding: 10px;
      background: #FFF7FA;
    }
    .visit-date {
      min-width: 120px;
      font-weight: bold;
      color: #B96A80;
    }
    .visit-time {
      flex: 1;
      margin-top: 0;
    }

    /* è¯­è¨€åˆ‡æ¢å™¨ */
    .lang-switch {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 999;
      display: inline-block;
    }

    .lang-trigger {
      border: 1px solid rgba(255, 182, 193, 0.5);
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      cursor: pointer;
      font-size: 13px;
      color: #6d4b5d;
      padding: 8px 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      backdrop-filter: blur(4px);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      min-height: 42px;
      min-width: 100px;
    }

    .lang-trigger:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(123, 79, 105, 0.2);
    }

    .lang-trigger:active {
      transform: translateY(0);
    }

    .lang-menu {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 150px;
      background: rgba(255, 255, 255, 0.94);
      border: 1px solid rgba(255, 182, 193, 0.45);
      border-radius: 10px;
      box-shadow: 0 10px 20px rgba(123, 79, 105, 0.16);
      padding: 6px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-6px);
      transition: opacity 0.18s ease, transform 0.18s ease, visibility 0.18s ease;
      backdrop-filter: blur(6px);
    }

    .lang-switch:hover .lang-menu,
    .lang-switch:focus-within .lang-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .lang-option {
      width: 100%;
      border: none;
      background: transparent;
      text-align: left;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      color: #6d4b5d;
      transition: background 0.2s ease;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      min-height: 40px;
      display: flex;
      align-items: center;
    }

    .lang-option:hover {
      background: rgba(255, 182, 193, 0.18);
    }

    .lang-option:active {
      background: rgba(255, 182, 193, 0.28);
    }

    .lang-option.active {
      border-color: #c75b7a;
      background: rgba(255, 182, 193, 0.24);
      font-weight: 600;
    }

    /* å“åº”å¼è®¾è®¡ */

    /* iPad å’Œå¹³æ¿ (768px - 1024px) */
    @media (max-width: 1024px) and (min-width: 769px) {
      body {
        padding: 15px;
      }

      .box {
        max-width: 600px;
        padding: 25px;
      }

      h2 {
        font-size: 22px;
        margin-bottom: 18px;
      }

      label {
        margin-top: 14px;
        font-size: 14px;
      }

      input, textarea, select {
        padding: 9px;
        font-size: 15px;
      }

      button {
        padding: 11px;
        font-size: 15px;
      }

      .date-row {
        gap: 6px;
      }

      .small-btn {
        padding: 7px 12px;
        font-size: 13px;
      }

      .visit-date {
        min-width: 110px;
        font-size: 13px;
      }
    }

    /* æ‰‹æœºå’Œå°è®¾å¤‡ (æœ€å¤§ 768px) */
    @media (max-width: 768px) {
      body {
        padding: 12px;
        min-height: auto;
      }

      .box {
        max-width: 100%;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(255, 182, 193, 0.1);
      }

      .lang-trigger {
        font-size: 12px;
        padding: 6px 10px;
      }

      h2 {
        font-size: 20px;
        margin-bottom: 16px;
        gap: 6px;
      }

      label {
        display: block;
        margin-top: 12px;
        font-size: 13px;
        font-weight: bold;
      }

      input, textarea, select {
        width: 100%;
        padding: 9px;
        margin-top: 5px;
        border: 2px solid #e5e5e5;
        border-radius: 6px;
        font-size: 14px;
      }

      button {
        width: 100%;
        margin-top: 16px;
        padding: 11px;
        font-size: 14px;
        border-radius: 6px;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        min-height: 44px;
      }

      .message {
        margin-top: 12px;
        padding: 10px;
        border-radius: 6px;
        font-size: 13px;
      }

      .date-row {
        flex-direction: column;
        gap: 8px;
      }

      .date-row input {
        width: 100%;
        margin-top: 0;
      }

      .small-btn {
        width: 100%;
        margin-top: 8px;
        padding: 9px 12px;
        font-size: 13px;
      }

      .date-help {
        font-size: 11px;
      }

      .visit-row {
        flex-direction: column;
        gap: 6px;
        padding: 8px;
      }

      .visit-date {
        min-width: auto;
        width: 100%;
        font-size: 12px;
      }

      .visit-time {
        width: 100%;
        font-size: 12px;
      }

      .date-tag {
        font-size: 12px;
        padding: 5px 10px;
      }

      #photoPreview {
        max-width: 150px;
      }
    }

    /* å°æ‰‹æœº (æœ€å¤§ 480px) */
    @media (max-width: 480px) {
      body {
        padding: 10px;
        background: linear-gradient(135deg, #FFF1F4 0%, #FFE1E8 100%);
      }

      .box {
        padding: 16px;
        border-radius: 8px;
      }

      h2 {
        font-size: 18px;
        margin-bottom: 14px;
        padding-bottom: 10px;
      }

      label {
        margin-top: 10px;
        font-size: 12px;
      }

      .required {
        font-size: 12px;
      }

      input, textarea, select {
        padding: 8px;
        margin-top: 4px;
        border-radius: 5px;
        font-size: 13px;
      }

      button {
        margin-top: 14px;
        padding: 10px;
        font-size: 13px;
        border-radius: 5px;
      }

      button:hover:not(:disabled) {
        transform: translateY(-1px);
      }

      .message {
        margin-top: 10px;
        padding: 8px;
        border-radius: 5px;
        font-size: 12px;
      }

      .date-row {
        gap: 6px;
      }

      .date-row input {
        font-size: 13px;
      }

      .small-btn {
        padding: 8px 10px;
        font-size: 12px;
      }

      .date-list {
        gap: 6px;
      }

      .date-tag {
        font-size: 11px;
        padding: 4px 8px;
      }

      .date-tag button {
        padding: 1px 6px;
        font-size: 11px;
      }

      .date-help {
        font-size: 10px;
        margin-top: 6px;
      }

      .visit-row {
        padding: 6px;
        gap: 4px;
      }

      .visit-date {
        font-size: 11px;
      }

      .visit-time {
        font-size: 11px;
      }

      #photoPreview {
        max-width: 120px;
        margin-top: 8px;
      }

      #photoPreview img {
        border-radius: 4px;
      }

      #photoPreview small {
        font-size: 10px;
      }
    }
  </style>


</head>

<body>
  <!-- è¯­è¨€é€‰æ‹©å™¨ -->
  <div class="lang-switch" aria-label="Language selector">
    <button type="button" class="lang-trigger" aria-haspopup="true">ğŸŒ è¯­è¨€</button>
    <div class="lang-menu" role="menu">
      <button type="button" class="lang-option" data-lang="zh" role="menuitem">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
      <button type="button" class="lang-option" data-lang="en" role="menuitem">ğŸ‡ºğŸ‡¸ English</button>
      <button type="button" class="lang-option" data-lang="ja" role="menuitem">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
    </div>
  </div>

  <div class="box">
    <h2 data-i18n="bookingTitle">é¢„çº¦ç”³è¯·</h2>

    <label data-i18n="contactTypeLabel">è”ç³»æ–¹å¼ç±»å‹ <span class="required">*</span></label>
    <select id="contactType">
      <option value="" data-i18n="contactTypeSelect">-- è¯·é€‰æ‹© --</option>
      <option value="ç”µè¯" data-i18n="contactTypePhone">ç”µè¯</option>
      <option value="å¾®ä¿¡" data-i18n="contactTypeWechat">å¾®ä¿¡</option>
      <option value="é‚®ç®±" data-i18n="contactTypeEmail">é‚®ç®±</option>
    </select>

    <label data-i18n="contactLabel">è”ç³»æ–¹å¼ <span class="required">*</span></label>
    <input id="contact" data-i18n="contactPlaceholder" placeholder="æ‰‹æœºï¼š090-1234-5678ï¼›å›ºå®šç”µè¯ï¼š0456-12-3456ï¼›é‚®ç®±ï¼šxxx@example.comï¼›å¾®ä¿¡ï¼šxxxxxxx" />

    <label data-i18n="ownerNameLabel">å®¢æˆ·å§“å <span class="required">*</span></label>
    <input id="ownerName" data-i18n="ownerNamePlaceholder" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" />

    <label data-i18n="prefectureLabel">ä¸Šé—¨åœ°åŒºï¼ˆéƒ½é“åºœçœŒï¼‰ <span class="required">*</span></label>
    <select id="prefecture" onchange="updateWard()">
      <option value="">-- è¯·é€‰æ‹©éƒ½é“åºœçœŒ --</option>
      <option data-i18n="pref_tokyo" value="æ±äº¬éƒ½">æ±äº¬éƒ½</option>
      <option data-i18n="pref_saitama" value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option>
      <option data-i18n="pref_kanagawa" value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option>
      <option data-i18n="pref_chiba" value="åƒè‘‰çœŒ">åƒè‘‰çœŒ</option>
    </select>

    <div id="citySection" style="display: none;">
      <label data-i18n="cityLabel">ä¸Šé—¨åœ°åŒºï¼ˆå¸‚ï¼‰ <span class="required">*</span></label>
      <select id="city" onchange="updateDistrict()">
        <option value="">-- å…ˆé€‰æ‹©éƒ½é“åºœçœŒ --</option>
      </select>
    </div>

    <label data-i18n="districtLabel">ä¸Šé—¨åœ°åŒºï¼ˆåŒºï¼‰ <span class="required">*</span></label>
    <select id="district">
      <option value="">-- å…ˆé€‰æ‹©å¸‚ --</option>
    </select>

    <label data-i18n="addressDetailLabel">è¯¦ç»†åœ°å€ï¼ˆä»å‡ ä¸ç›®åå¼€å§‹è¾“å…¥ï¼Œä¾‹ï¼š1-2-3 â—‹â—‹ãƒ“ãƒ«3éšï¼‰ <span class="required">*</span></label>
    <input id="addressDetail" data-i18n="addressDetailPlaceholder" placeholder="ä¾‹å¦‚ï¼š1-2-3ã€1ç•ªåœ°1å·ã€â—‹â—‹ãƒ“ãƒ«3éšï¼ˆå‡ ä¸ç›®å‰é¢çš„å†…å®¹è¯·åœ¨ä¸Šæ–¹ä¸‹æ‹‰é€‰æ‹©ï¼‰" />

    <label data-i18n="catNameLabel">çŒ«å’ªåå­— <span class="required">*</span></label>
    <input id="catName" data-i18n="catNamePlaceholder" placeholder="è¯·è¾“å…¥çŒ«å’ªåå­—" />

    <label data-i18n="catAgeLabel">çŒ«å’ªå¹´é¾„ <span class="required">*</span></label>
    <input id="catAge" data-i18n="catAgePlaceholder" placeholder="ä¾‹å¦‚ï¼š3å²" />

    <label data-i18n="bookingModeLabel">é¢„çº¦æ–¹å¼ <span class="required">*</span></label>
    <select id="bookingMode" onchange="onBookingModeChange()">
      <option data-i18n="bookingModeSeparate" value="separate">åˆ†å¼€æ—¥æœŸï¼ˆä¸è¿ç»­ï¼‰</option>
      <option data-i18n="bookingModeRange" value="range">ä¸€æ®µåŒºé—´ï¼ˆè¿ç»­ï¼‰</option>
    </select>

    <div id="separateDateSection">
      <label data-i18n="serviceDateSeparateLabel">æœåŠ¡æ—¥æœŸï¼ˆåˆ†å¼€æ·»åŠ ï¼‰ <span class="required">*</span></label>
      <div class="date-row">
        <input type="date" id="date" />
        <button type="button" class="small-btn" data-i18n="addDateBtn" onclick="addSingleDate()">æ·»åŠ æ—¥æœŸ</button>
      </div>
    </div>

    <div id="rangeDateSection" style="display: none;">
      <label data-i18n="serviceDateRangeLabel">æœåŠ¡æ—¥æœŸåŒºé—´ <span class="required">*</span></label>
      <div class="date-row">
        <input type="date" id="startDate" />
        <input type="date" id="endDate" />
        <button type="button" class="small-btn" data-i18n="addRangeBtn" onclick="addDateRange()">æ·»åŠ åŒºé—´</button>
      </div>
    </div>

    <div class="date-help" data-i18n="dateHelp">æ·»åŠ åè¯·ä¸ºæ¯ä¸ªæ—¥æœŸåˆ†åˆ«é€‰æ‹©ä¸Šé—¨æ—¶é—´ï¼›åŒºé—´ä¿®æ”¹æ—¶ä¼šä¿ç•™é‡å æ—¥æœŸçš„æ—¶é—´è®¾ç½®</div>
    <div id="visitList" class="visit-list"></div>

    <label data-i18n="noteLabel">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
    <textarea id="note" data-i18n="notePlaceholder" placeholder="ä¾‹å¦‚ï¼šçŒ«å’ªæ€§æ ¼ã€ç‰¹æ®Šéœ€æ±‚ç­‰"></textarea>

    <label data-i18n="photoLabel">çŒ«å’ªç…§ç‰‡ï¼ˆå¯é€‰ï¼ŒJPGæ ¼å¼ï¼Œæœ€å¤§5MBï¼‰</label>
    <input type="file" id="photo" accept="image/jpeg,image/jpg" />
    <div id="photoPreview" style="margin-top: 10px; max-width: 200px;"></div>

    <button id="submitBtn" data-i18n="submitBtn" onclick="submitAppointment()">æäº¤é¢„çº¦</button>

    <div id="message" class="message"></div>
    <div class="date-help"><a href="/manage-appointment.html" data-i18n="getReservation">å·²æœ‰é¢„çº¦ï¼Ÿç‚¹æ­¤æ‰¾å›é¢„çº¦ï¼Œéšåè¿›å…¥ç‹¬ç«‹é¡µé¢ä¿®æ”¹æˆ–å–æ¶ˆ</a></div>
  </div>

  <!-- âœ… EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

  <!-- âœ… åˆå§‹åŒ– -->
  <script>
    emailjs.init("MMb0p4BWJBxDK-Sgk");
  </script>

  <!-- âœ… ä¸šåŠ¡é€»è¾‘ -->
  <script>
    // çº§è”èœå•æ•°æ®ï¼ˆ3å¿å…¨å¸‚ + ä¸œäº¬23åŒºï¼‰
    var areaData = {
      "æ±äº¬éƒ½": {
        type: "ward",
        items: [
          "åƒä»£ç”°åŒº", "ä¸­å¤®åŒº", "æ¸¯åŒº", "æ–°å®¿åŒº", "æ–‡äº¬åŒº", "å°æ±åŒº", "å¢¨ç”°åŒº", "æ±Ÿæ±åŒº",
          "å“å·åŒº", "ç›®é»’åŒº", "å¤§ç”°åŒº", "ä¸–ç”°è°·åŒº", "æ¸‹è°·åŒº", "ä¸­é‡åŒº", "æ‰ä¸¦åŒº", "è±Šå³¶åŒº",
          "åŒ—åŒº", "è’å·åŒº", "æ¿æ©‹åŒº", "ç·´é¦¬åŒº", "è¶³ç«‹åŒº", "è‘›é£¾åŒº", "æ±Ÿæˆ¸å·åŒº"
        ]
      },
      "åŸ¼ç‰çœŒ": {
        type: "city",
        items: [
          "ã•ã„ãŸã¾å¸‚", "å·è¶Šå¸‚", "ç†Šè°·å¸‚", "å·å£å¸‚", "è¡Œç”°å¸‚", "ç§©çˆ¶å¸‚", "æ‰€æ²¢å¸‚", "é£¯èƒ½å¸‚",
          "åŠ é ˆå¸‚", "æœ¬åº„å¸‚", "æ±æ¾å±±å¸‚", "æ˜¥æ—¥éƒ¨å¸‚", "ç‹­å±±å¸‚", "ç¾½ç”Ÿå¸‚", "é´»å·£å¸‚", "æ·±è°·å¸‚",
          "ä¸Šå°¾å¸‚", "è‰åŠ å¸‚", "è¶Šè°·å¸‚", "è•¨å¸‚", "æˆ¸ç”°å¸‚", "å…¥é–“å¸‚", "æœéœå¸‚", "å¿—æœ¨å¸‚",
          "å’Œå…‰å¸‚", "æ–°åº§å¸‚", "æ¡¶å·å¸‚", "ä¹…å–œå¸‚", "åŒ—æœ¬å¸‚", "å…«æ½®å¸‚", "å¯Œå£«è¦‹å¸‚", "ä¸‰éƒ·å¸‚",
          "è“®ç”°å¸‚", "å‚æˆ¸å¸‚", "å¹¸æ‰‹å¸‚", "é¶´ãƒ¶å³¶å¸‚", "æ—¥é«˜å¸‚", "å‰å·å¸‚", "ãµã˜ã¿é‡å¸‚", "ç™½å²¡å¸‚"
        ]
      },
      "ç¥å¥ˆå·çœŒ": {
        type: "city",
        items: [
          "æ¨ªæµœå¸‚", "å·å´å¸‚", "ç›¸æ¨¡åŸå¸‚", "æ¨ªé ˆè³€å¸‚", "å¹³å¡šå¸‚", "éŒå€‰å¸‚", "è—¤æ²¢å¸‚", "å°ç”°åŸå¸‚",
          "èŒ…ãƒ¶å´å¸‚", "é€—å­å¸‚", "ä¸‰æµ¦å¸‚", "ç§¦é‡å¸‚", "åšæœ¨å¸‚", "å¤§å’Œå¸‚", "ä¼Šå‹¢åŸå¸‚", "æµ·è€åå¸‚",
          "åº§é–“å¸‚", "å—è¶³æŸ„å¸‚", "ç¶¾ç€¬å¸‚"
        ]
      },
      "åƒè‘‰çœŒ": {
        type: "city",
        items: [
          "åƒè‘‰å¸‚", "éŠšå­å¸‚", "å¸‚å·å¸‚", "èˆ¹æ©‹å¸‚", "é¤¨å±±å¸‚", "æœ¨æ›´æ´¥å¸‚", "æ¾æˆ¸å¸‚", "é‡ç”°å¸‚",
          "èŒ‚åŸå¸‚", "æˆç”°å¸‚", "ä½å€‰å¸‚", "æ±é‡‘å¸‚", "æ—­å¸‚", "ç¿’å¿—é‡å¸‚", "æŸå¸‚", "å‹æµ¦å¸‚",
          "å¸‚åŸå¸‚", "æµå±±å¸‚", "å…«åƒä»£å¸‚", "æˆ‘å­«å­å¸‚", "é´¨å·å¸‚", "éŒã‚±è°·å¸‚", "å›æ´¥å¸‚", "å¯Œæ´¥å¸‚",
          "æµ¦å®‰å¸‚", "å››è¡—é“å¸‚", "è¢–ã‚±æµ¦å¸‚", "å…«è¡—å¸‚", "å°è¥¿å¸‚", "ç™½äº•å¸‚", "å¯Œé‡Œå¸‚", "å—æˆ¿ç·å¸‚",
          "åŒç‘³å¸‚", "é¦™å–å¸‚", "å±±æ­¦å¸‚", "ã„ã™ã¿å¸‚", "å¤§ç¶²ç™½é‡Œå¸‚"
        ]
      }
    };

    var TOWN_API = "https://geoapi.heartrails.com/api/json?method=getTowns";
    var TIME_OPTIONS = [
      "ä¸Šåˆ 9:00-12:00",
      "ä¸‹åˆ 13:00-17:00",
      "æ™šä¸Š 18:00-21:00"
    ];
    var selectedVisits = [];

    // æ›´æ–°å¸‚/åŒºçš„çº§è”èœå•å‡½æ•°
    function updateWard() {
      var prefecture = document.getElementById("prefecture").value;
      var citySection = document.getElementById("citySection");
      var citySelect = document.getElementById("city");
      var districtSelect = document.getElementById("district");
      
      // æ¸…ç©ºå¸‚å’ŒåŒº
      citySelect.innerHTML = '';
      districtSelect.innerHTML = '';
      
      if (!prefecture) {
        citySelect.innerHTML = '<option value="">-- å…ˆé€‰æ‹©éƒ½é“åºœçœŒ --</option>';
        districtSelect.innerHTML = '<option value="">-- å…ˆé€‰æ‹©å¸‚ --</option>';
        citySection.style.display = 'none';
        return;
      }
      
      var prefData = areaData[prefecture];
      if (prefData.type === "ward") {
        // ä¸œäº¬ç‰¹æ®Šå¤„ç†ï¼šç›´æ¥æ˜¾ç¤ºåŒºï¼Œéšè—å¸‚é€‰æ‹©
        citySection.style.display = 'none';
        citySelect.value = '';
        districtSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©' + prefecture + 'çš„åŒº --</option>';
        prefData.items.forEach(function(ward) {
          var option = document.createElement("option");
          option.value = prefecture + ward;
          option.textContent = ward;
          districtSelect.appendChild(option);
        });
      } else {
        // å…¶ä»–å¿ï¼šæ˜¾ç¤ºå¸‚é€‰æ‹©ï¼Œç„¶åæŒ‰å¸‚åŠ¨æ€åŠ è½½åŒº/ç”ºåŸŸ
        citySection.style.display = 'block';
        citySelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å¸‚ --</option>';
        districtSelect.innerHTML = '<option value="">-- å…ˆé€‰æ‹©å¸‚ --</option>';
        prefData.items.forEach(function(city) {
          var option = document.createElement("option");
          option.value = city;
          option.textContent = city;
          citySelect.appendChild(option);
        });
      }
    }

    // æ›´æ–°åŒºçš„çº§è”èœå•å‡½æ•°
    function updateDistrict() {
      var prefecture = document.getElementById("prefecture").value;
      var city = document.getElementById("city").value;
      var districtSelect = document.getElementById("district");
      
      districtSelect.innerHTML = '';
      
      if (!prefecture || !city) {
        districtSelect.innerHTML = '<option value="">-- å…ˆé€‰æ‹©å¸‚ --</option>';
        return;
      }
      
      districtSelect.innerHTML = '<option value="">-- æ­£åœ¨åŠ è½½åŒº/ç”ºåŸŸ... --</option>';

      var url = TOWN_API + "&prefecture=" + encodeURIComponent(prefecture) + "&city=" + encodeURIComponent(city);
      
      var success = function(json) {
        var locations = (json && json.response && json.response.location) || [];
        var townSet = new Set();
        for (var i = 0; i < locations.length; i++) {
          if (locations[i].town) {
            townSet.add(locations[i].town);
          }
        }
        var towns = Array.prototype.slice.call(townSet);

        districtSelect.innerHTML = '';
        if (towns.length === 0) {
          districtSelect.innerHTML = '<option value="' + city + '">' + city + 'ï¼ˆå…¨åŸŸï¼‰</option>';
          districtSelect.value = city + 'ï¼ˆå…¨åŸŸï¼‰';
          return;
        }

        districtSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©' + city + 'çš„åŒº/ç”ºåŸŸ --</option>';
        towns.forEach(function(town) {
          var option = document.createElement("option");
          option.value = town;
          option.textContent = town;
          districtSelect.appendChild(option);
        });
      };
      
      var error = function() {
        districtSelect.innerHTML = '<option value="' + city + '">' + city + 'ï¼ˆå…¨åŸŸï¼‰</option>';
        districtSelect.value = city + 'ï¼ˆå…¨åŸŸï¼‰';
      };

      if (typeof fetch !== 'undefined') {
        fetch(url)
          .then(function(res) { return res.json(); })
          .then(success)
          .catch(error);
      } else {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              try {
                var json = JSON.parse(xhr.responseText);
                success(json);
              } catch(e) {
                error();
              }
            } else {
              error();
            }
          }
        };
        xhr.onerror = error;
        xhr.open("GET", url);
        xhr.send();
      }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(text, type) {
      var msg = document.getElementById("message");
      msg.textContent = text;
      msg.className = "message " + type;
      msg.style.display = "block";
      if (type === "success") {
        setTimeout(function() {
          msg.style.display = "none";
          clearForm();
        }, 3000);
      }
    }

    function getTodayISO() {
      var today = new Date();
      var yyyy = today.getFullYear();
      var m = today.getMonth() + 1;
      var mm = (m < 10 ? "0" : "") + m;
      var d = today.getDate();
      var dd = (d < 10 ? "0" : "") + d;
      return yyyy + "-" + mm + "-" + dd;
    }

    function onBookingModeChange() {
      var mode = document.getElementById("bookingMode").value;
      var separateSection = document.getElementById("separateDateSection");
      var rangeSection = document.getElementById("rangeDateSection");
      if (mode === "range") {
        separateSection.style.display = "none";
        rangeSection.style.display = "block";
      } else {
        separateSection.style.display = "block";
        rangeSection.style.display = "none";
      }
    }

    function renderVisitList() {
      var visitList = document.getElementById("visitList");
      visitList.innerHTML = "";

      // å¦‚æœæ²¡æœ‰è®¿é—®åˆ—è¡¨ï¼Œä¸æ˜¾ç¤ºä»»ä½•å†…å®¹
      if (!selectedVisits || selectedVisits.length === 0) {
        return;
      }

      selectedVisits.forEach(function(visit) {
        var row = document.createElement("div");
        row.className = "visit-row";

        var dateLabel = document.createElement("span");
        dateLabel.className = "visit-date";
        dateLabel.textContent = visit.date;

        var timeSelect = document.createElement("select");
        timeSelect.className = "visit-time";
        timeSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©ä¸Šé—¨æ—¶é—´ --</option>';
        
        // ç¡®ä¿ TIME_OPTIONS è¢«æ­£ç¡®ä½¿ç”¨
        if (TIME_OPTIONS && TIME_OPTIONS.length > 0) {
          TIME_OPTIONS.forEach(function(timeText) {
            var option = document.createElement("option");
            option.value = timeText;
            option.textContent = timeText;
            if (visit.time === timeText) {
              option.selected = true;
            }
            timeSelect.appendChild(option);
          });
        }
        
        timeSelect.onchange = (function(currentVisitDate) {
          return function(event) {
            updateVisitTime(currentVisitDate, event.target.value);
          };
        })(visit.date);

        var removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "small-btn";
        removeBtn.style.background = "#d9534f";
        removeBtn.textContent = "åˆ é™¤";
        removeBtn.onclick = (function(currentVisitDate) {
          return function() {
            removeVisitDate(currentVisitDate);
          };
        })(visit.date);

        row.appendChild(dateLabel);
        row.appendChild(timeSelect);
        row.appendChild(removeBtn);
        visitList.appendChild(row);
      });
    }

    function updateVisitTime(dateValue, timeValue) {
      selectedVisits = selectedVisits.map(function(visit) {
        if (visit.date === dateValue) {
          return Object.assign({}, visit, { time: timeValue });
        }
        return visit;
      });
    }

    function addVisitDate(dateValue) {
      if (selectedVisits.some(function(visit) { return visit.date === dateValue; })) {
        showMessage("âŒ è¯¥æ—¥æœŸå·²æ·»åŠ ", "error");
        return false;
      }

      var todayISO = getTodayISO();
      if (dateValue < todayISO) {
        showMessage("âŒ æœåŠ¡æ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸ", "error");
        return false;
      }

      selectedVisits.push({ date: dateValue, time: "" });
      selectedVisits.sort(function(a, b) { return a.date.localeCompare(b.date); });
      renderVisitList();
      return true;
    }

    function addSingleDate() {
      var dateInput = document.getElementById("date");
      var dateValue = dateInput.value;
      if (!dateValue) {
        showMessage("âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ—¥æœŸ", "error");
        return;
      }

      var todayISO = getTodayISO();
      if (dateValue < todayISO) {
        dateInput.classList.add("past-date");
        showMessage("âŒ æœåŠ¡æ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸ", "error");
        dateInput.value = "";
        dateInput.classList.remove("past-date");
        return;
      }

      var added = addVisitDate(dateValue);
      if (!added) {
        return;
      }

      dateInput.value = "";
      showMessage("âœ… æ—¥æœŸå·²æ·»åŠ ï¼Œè¯·ä¸ºè¯¥æ—¥æœŸé€‰æ‹©æ—¶é—´", "loading");
    }

    function addDateRange() {
      var startDate = document.getElementById("startDate").value;
      var endDate = document.getElementById("endDate").value;

      if (!startDate || !endDate) {
        showMessage("âŒ è¯·å…ˆé€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ", "error");
        return;
      }

      var todayISO = getTodayISO();
      if (startDate < todayISO) {
        document.getElementById("startDate").classList.add("past-date");
        showMessage("âŒ å¼€å§‹æ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸ", "error");
        document.getElementById("startDate").value = "";
        document.getElementById("startDate").classList.remove("past-date");
        return;
      }

      if (endDate < todayISO) {
        document.getElementById("endDate").classList.add("past-date");
        showMessage("âŒ ç»“æŸæ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸ", "error");
        document.getElementById("endDate").value = "";
        document.getElementById("endDate").classList.remove("past-date");
        return;
      }

      if (endDate < startDate) {
        showMessage("âŒ ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ", "error");
        return;
      }

      // æ™ºèƒ½åŒºé—´æ›´æ–°ï¼šé‡å æ—¥æœŸä¿ç•™åŸæ—¶é—´ï¼Œè¶…å‡ºèŒƒå›´è‡ªåŠ¨ç§»é™¤ï¼Œæ–°æ—¥æœŸè‡ªåŠ¨è¡¥å……
      var nextDateArray = [];
      var startParts = startDate.split("-");
      var endParts = endDate.split("-");
      var current = new Date(parseInt(startParts[0]), parseInt(startParts[1]) - 1, parseInt(startParts[2]));
      var end = new Date(parseInt(endParts[0]), parseInt(endParts[1]) - 1, parseInt(endParts[2]));

      while (current <= end) {
        var yyyy = current.getFullYear();
        var m = current.getMonth() + 1;
        var mm = (m < 10 ? "0" : "") + m;
        var d = current.getDate();
        var dd = (d < 10 ? "0" : "") + d;
        nextDateArray.push(yyyy + "-" + mm + "-" + dd);
        current.setDate(current.getDate() + 1);
      }

      var visitMap = {};
      selectedVisits.forEach(function(visit) {
        visitMap[visit.date] = visit;
      });
      var nextVisits = [];
      var addedCount = 0;
      nextDateArray.forEach(function(dateValue) {
        if (visitMap.hasOwnProperty(dateValue)) {
          nextVisits.push(visitMap[dateValue]);
        } else {
          nextVisits.push({ date: dateValue, time: "" });
          addedCount += 1;
        }
      });

      selectedVisits = nextVisits;
      renderVisitList();

      if (addedCount > 0) {
        showMessage("âœ… å·²æ·»åŠ  " + addedCount + " ä¸ªæ—¥æœŸï¼ˆ" + startDate + " è‡³ " + endDate + "ï¼‰ï¼Œè¯·ä¸ºæ¯ä¸ªæ—¥æœŸé€‰æ‹©æ—¶é—´", "loading");
      } else {
        showMessage("âœ… åŒºé—´å·²æ›´æ–°ï¼ˆ" + startDate + " è‡³ " + endDate + "ï¼‰ï¼Œå·²ä¿ç•™é‡å æ—¥æœŸçš„æ—¶é—´è®¾ç½®", "loading");
      }
    }

    function removeVisitDate(dateValue) {
      var newVisits = [];
      for (var i = 0; i < selectedVisits.length; i++) {
        if (selectedVisits[i].date !== dateValue) {
          newVisits.push(selectedVisits[i]);
        }
      }
      selectedVisits = newVisits;
      renderVisitList();
    }

    // è®¾ç½®æ—¥æœŸæœ€å°å€¼ï¼ˆè¿‡å»æ—¥æœŸä¸å¯é€‰ï¼‰
    function setDateMin() {
      var dateInput = document.getElementById("date");
      var startDateInput = document.getElementById("startDate");
      var endDateInput = document.getElementById("endDate");
      var todayISO = getTodayISO();
      dateInput.min = todayISO;
      startDateInput.min = todayISO;
      endDateInput.min = todayISO;
    }

    // æ¸…ç©ºè¡¨å•
    function clearForm() {
      document.getElementById("contactType").value = "";
      document.getElementById("contact").value = "";
      document.getElementById("ownerName").value = "";
      document.getElementById("prefecture").value = "";
      document.getElementById("city").value = "";
      document.getElementById("district").value = "";
      document.getElementById("addressDetail").value = "";
      document.getElementById("catName").value = "";
      document.getElementById("catAge").value = "";
      document.getElementById("bookingMode").value = "separate";
      document.getElementById("date").value = "";
      document.getElementById("startDate").value = "";
      document.getElementById("endDate").value = "";
      selectedVisits = [];
      renderVisitList();
      onBookingModeChange();
      document.getElementById("note").value = "";
      setDateMin();
      updateWard();
    }

    // éªŒè¯è¡¨å•
    function validateForm() {
      var contactType = document.getElementById("contactType").value;
      var contact = (document.getElementById("contact").value || "").trim();
      var ownerName = (document.getElementById("ownerName").value || "").trim();
      var prefecture = document.getElementById("prefecture").value;
      var city = document.getElementById("city").value;
      var district = document.getElementById("district").value;
      var addressDetail = (document.getElementById("addressDetail").value || "").trim();
      var catName = (document.getElementById("catName").value || "").trim();
      var catAge = (document.getElementById("catAge").value || "").trim();

      // å¿…å¡«æ£€æŸ¥
      if (!ownerName) return "âŒ å®¢æˆ·å§“åä¸èƒ½ä¸ºç©º";
      if (!contactType) return "âŒ è”ç³»æ–¹å¼ç±»å‹ä¸èƒ½ä¸ºç©º";
      if (!contact) return "âŒ è”ç³»æ–¹å¼ä¸èƒ½ä¸ºç©º";
      if (!prefecture) return "âŒ éƒ½é“åºœçœŒä¸èƒ½ä¸ºç©º";
      if (!city && areaData[prefecture].type === "city") return "âŒ å¸‚ä¸èƒ½ä¸ºç©º";
      if (!district) return "âŒ åŒº/å¸‚ä¸èƒ½ä¸ºç©º";
      if (!addressDetail) return "âŒ è¯¦ç»†åœ°å€ä¸èƒ½ä¸ºç©º";
      if (!catName) return "âŒ çŒ«å’ªåå­—ä¸èƒ½ä¸ºç©º";
      if (!catAge) return "âŒ çŒ«å’ªå¹´é¾„ä¸èƒ½ä¸ºç©º";
      if (selectedVisits.length === 0) return "âŒ è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæœåŠ¡æ—¥æœŸ";

      for (var i = 0; i < selectedVisits.length; i++) {
        var visit = selectedVisits[i];
        if (!visit.time) {
          return "âŒ è¯·ä¸ºæ—¥æœŸ " + visit.date + " é€‰æ‹©ä¸Šé—¨æ—¶é—´";
        }
      }

      // æ ¹æ®ç±»å‹éªŒè¯è”ç³»æ–¹å¼
      if (contactType === "ç”µè¯") {
        // æ—¥æœ¬ç”µè¯ï¼š
        // æ‰‹æœºï¼š090-1234-5678 æˆ– 09012345678ï¼ˆ11ä½ï¼‰
        // å›ºå®šç”µè¯ï¼š0456-12-3456 æˆ– 045612345ï¼ˆ10ä½ï¼‰
        var phoneDigits = contact.replace(/-/g, "");
        if (!/^0\d{9,10}$/.test(phoneDigits)) {
          return "âŒ ç”µè¯æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æ‰‹æœºï¼ˆ090-1234-5678ï¼‰æˆ–å›ºå®šç”µè¯ï¼ˆ0456-12-3456ï¼‰";
        }
      } else if (contactType === "é‚®ç®±") {
        // é‚®ç®±æ ¼å¼éªŒè¯
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(contact)) {
          return "âŒ é‚®ç®±æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€";
        }
      } else if (contactType === "å¾®ä¿¡") {
        // å¾®ä¿¡å·é•¿åº¦æ£€æŸ¥
        if (contact.length < 5 || contact.length > 20) {
          return "âŒ å¾®ä¿¡å·é•¿åº¦åº”åœ¨ 5-20 ä¸ªå­—ç¬¦ä¹‹é—´";
        }
      }

      // æ—¥æœŸæ£€æŸ¥ï¼ˆä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸï¼‰
      var todayISO = getTodayISO();
      for (var i = 0; i < selectedVisits.length; i++) {
        var visit = selectedVisits[i];
        if (visit.date < todayISO) {
          return "âŒ æœåŠ¡æ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸ";
        }
      }

      return null; // éªŒè¯é€šè¿‡
    }

    function submitAppointment() {
      // éªŒè¯è¡¨å•
      var validationError = validateForm();
      if (validationError) {
        showMessage(validationError, "error");
        return;
      }

      var submit_btn = document.getElementById("submitBtn");
      var prefecture = document.getElementById("prefecture").value;
      var city = document.getElementById("city").value;
      var district = document.getElementById("district").value;
      var addressDetail = (document.getElementById("addressDetail").value || "").trim();
      
      // æ ¹æ®éƒ½é“åºœçœŒç±»å‹ç»„åˆåœ°å€
      var address = "";
      var prefData = areaData[prefecture];
      if (prefData.type === "ward") {
        address = prefecture + district + " " + addressDetail;
      } else {
        address = prefecture + city + district + " " + addressDetail;
      }
      
      var datesList = [];
      var timeList = [];
      for (var i = 0; i < selectedVisits.length; i++) {
        datesList.push(selectedVisits[i].date);
        timeList.push(selectedVisits[i].date + " " + selectedVisits[i].time);
      }
      
      // ä½¿ç”¨ FormData æ”¯æŒæ–‡ä»¶ä¸Šä¼ 
      var formData = new FormData();
      formData.append("ownerName", (document.getElementById("ownerName").value || "").trim());
      formData.append("contactType", document.getElementById("contactType").value);
      formData.append("contact", (document.getElementById("contact").value || "").trim());
      formData.append("address", address);
      formData.append("catName", (document.getElementById("catName").value || "").trim());
      formData.append("catAge", (document.getElementById("catAge").value || "").trim());
      formData.append("date", selectedVisits[0].date);
      formData.append("dates", JSON.stringify(datesList));
      formData.append("visits", JSON.stringify(selectedVisits));
      formData.append("time", timeList.join("ï¼›"));
      formData.append("note", (document.getElementById("note").value || "").trim());
      
      // æ·»åŠ ç…§ç‰‡æ–‡ä»¶
      var photoInput = document.getElementById("photo");
      if (photoInput.files && photoInput.files[0]) {
        formData.append("photo", photoInput.files[0]);
      }

      // ç¦ç”¨æäº¤æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
      submit_btn.disabled = true;
      showMessage("â³ æäº¤ä¸­ï¼Œè¯·ç¨å€™...", "loading");

      var makeRequest = function() {
        if (typeof fetch !== 'undefined') {
          fetch("/api/appointment", {
            method: "POST",
            body: formData
          })
          .then(function(res) {
            if (!res.ok) {
              return res.json().then(function(json) {
                throw new Error(json.message || "æäº¤å¤±è´¥");
              });
            }
            return res.json();
          })
          .then(function(result) {
            var reservationNumber = result && result.reservationNumber ? result.reservationNumber : "";
            if (reservationNumber) {
              alert("æäº¤æˆåŠŸï¼\né¢„çº¦å·ï¼š" + reservationNumber + "\nè¯·æˆªå›¾ä¿å­˜ï¼Œç”¨äºåç»­è‡ªåŠ©ä¿®æ”¹æˆ–å–æ¶ˆã€‚");
              showMessage("âœ… " + result.message + "ï¼Œé¢„çº¦å·ï¼š" + reservationNumber + "ï¼ˆè¯·æˆªå›¾ä¿å­˜ï¼‰", "success");
            } else {
              alert("æ‚¨å·²æäº¤ï¼Œè¯·ç­‰å¾…å·¥ä½œäººå‘˜è”ç³»");
              showMessage("âœ… " + result.message + "ï¼Œè¯·ç­‰å¾…å·¥ä½œäººå‘˜è”ç³»", "success");
            }
            submit_btn.disabled = false;
            
            // å°è¯•å‘é€ EmailJSï¼ˆéå¿…è¦ï¼‰
            try {
              if (typeof emailjs !== 'undefined' && emailjs.send) {
                emailjs.send("service_b91fibq", "template_63ko5qi", data).catch(function(err) {
                  console.warn("é‚®ä»¶å‘é€å¤±è´¥ï¼ˆä¸å½±å“æ•°æ®åº“ä¿å­˜ï¼‰", err);
                });
              }
            } catch(emailErr) {
              console.warn("é‚®ä»¶å‘é€å¤±è´¥ï¼ˆä¸å½±å“æ•°æ®åº“ä¿å­˜ï¼‰", emailErr);
            }
          })
          .catch(function(e) {
            console.error("âŒ é”™è¯¯ï¼š", e);
            var errMsg = e && e.message ? e.message : "æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•";
            showMessage("âŒ " + errMsg, "error");
            submit_btn.disabled = false;
          });
        } else {
          // IE9+: XMLHttpRequest
          var xhr = new XMLHttpRequest();
          xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
              submit_btn.disabled = false;
              try {
                var result = JSON.parse(xhr.responseText);
                if (xhr.status === 200 || xhr.status === 201) {
                  var reservationNumber = result && result.reservationNumber ? result.reservationNumber : "";
                  if (reservationNumber) {
                    alert("æäº¤æˆåŠŸï¼\né¢„çº¦å·ï¼š" + reservationNumber + "\nè¯·æˆªå›¾ä¿å­˜ï¼Œç”¨äºåç»­è‡ªåŠ©ä¿®æ”¹æˆ–å–æ¶ˆã€‚");
                    showMessage("âœ… " + result.message + "ï¼Œé¢„çº¦å·ï¼š" + reservationNumber + "ï¼ˆè¯·æˆªå›¾ä¿å­˜ï¼‰", "success");
                  } else {
                    alert("æ‚¨å·²æäº¤ï¼Œè¯·ç­‰å¾…å·¥ä½œäººå‘˜è”ç³»");
                    showMessage("âœ… " + result.message + "ï¼Œè¯·ç­‰å¾…å·¥ä½œäººå‘˜è”ç³»", "success");
                  }
                  
                  // å°è¯•å‘é€ EmailJSï¼ˆéå¿…è¦ï¼‰
                  try {
                    if (typeof emailjs !== 'undefined' && emailjs.send) {
                      emailjs.send("service_b91fibq", "template_63ko5qi", data).catch(function(err) {
                        console.warn("é‚®ä»¶å‘é€å¤±è´¥ï¼ˆä¸å½±å“æ•°æ®åº“ä¿å­˜ï¼‰", err);
                      });
                    }
                  } catch(emailErr) {
                    console.warn("é‚®ä»¶å‘é€å¤±è´¥ï¼ˆä¸å½±å“æ•°æ®åº“ä¿å­˜ï¼‰", emailErr);
                  }
                } else {
                  var errMsg = result.message || "æäº¤å¤±è´¥";
                  showMessage("âŒ " + errMsg, "error");
                }
              } catch(e) {
                showMessage("âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•", "error");
              }
            }
          };
          xhr.onerror = function() {
            submit_btn.disabled = false;
            showMessage("âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥", "error");
          };
          xhr.ontimeout = function() {
            submit_btn.disabled = false;
            showMessage("âŒ è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•", "error");
          };
          xhr.open("POST", "/api/appointment");
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.timeout = 30000;
          xhr.send(JSON.stringify(data));
        }
      };
      
      makeRequest();
    }

    setDateMin();
    onBookingModeChange();

    // å®æ—¶ç›‘å¬æ—¥æœŸè¾“å…¥æ¡†ï¼Œç¦æ­¢è¿‡å»æ—¥æœŸ
    document.getElementById("date").addEventListener("change", function() {
      var todayISO = getTodayISO();
      if (this.value && this.value < todayISO) {
        this.classList.add("past-date");
        showMessage("âŒ æœåŠ¡æ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸï¼Œè¯·é‡æ–°é€‰æ‹©", "error");
        this.value = "";
        this.classList.remove("past-date");
      } else {
        this.classList.remove("past-date");
      }
    }, false);

    document.getElementById("startDate").addEventListener("change", function() {
      var todayISO = getTodayISO();
      if (this.value && this.value < todayISO) {
        this.classList.add("past-date");
        showMessage("âŒ å¼€å§‹æ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸï¼Œè¯·é‡æ–°é€‰æ‹©", "error");
        this.value = "";
        this.classList.remove("past-date");
      } else {
        this.classList.remove("past-date");
      }
    }, false);

    document.getElementById("endDate").addEventListener("change", function() {
      var todayISO = getTodayISO();
      if (this.value && this.value < todayISO) {
        this.classList.add("past-date");
        showMessage("âŒ ç»“æŸæ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸï¼Œè¯·é‡æ–°é€‰æ‹©", "error");
        this.value = "";
        this.classList.remove("past-date");
      } else {
        this.classList.remove("past-date");
      }
    }, false);

    // ===== å¤šè¯­è¨€ç³»ç»Ÿ (i18n) =====
    window.I18N = {
      zh: {
        pageTitle: "çŒ«å’ªä¸Šé—¨çœ‹æŠ¤é¢„çº¦",
        bookingTitle: "é¢„çº¦ç”³è¯·",
        contactTypeLabel: "è”ç³»æ–¹å¼ç±»å‹",
        contactTypeSelect: "-- è¯·é€‰æ‹© --",
        contactTypePhone: "ç”µè¯",
        contactTypeWechat: "å¾®ä¿¡",
        contactTypeEmail: "é‚®ç®±",
        contactLabel: "è”ç³»æ–¹å¼",
        contactPlaceholder: "æ‰‹æœºï¼š090-1234-5678ï¼›å›ºå®šç”µè¯ï¼š0456-12-3456ï¼›é‚®ç®±ï¼šxxx@example.comï¼›å¾®ä¿¡ï¼šxxxxxxx",
        ownerNameLabel: "å®¢æˆ·å§“å",
        ownerNamePlaceholder: "è¯·è¾“å…¥æ‚¨çš„å§“å",
        prefectureLabel: "ä¸Šé—¨åœ°åŒºï¼ˆéƒ½é“åºœçœŒï¼‰",
        prefectureSelect: "-- è¯·é€‰æ‹©éƒ½é“åºœçœŒ --",
        pref_tokyo: "ä¸œäº¬éƒ½",
        pref_saitama: "åŸ¼ç‰å¿",
        pref_kanagawa: "ç¥å¥ˆå·å¿",
        pref_chiba: "åƒå¶å¿",
        cityLabel: "ä¸Šé—¨åœ°åŒºï¼ˆå¸‚ï¼‰",
        citySelect: "-- å…ˆé€‰æ‹©éƒ½é“åºœçœŒ --",
        districtLabel: "ä¸Šé—¨åœ°åŒºï¼ˆåŒºï¼‰",
        districtSelect: "-- å…ˆé€‰æ‹©å¸‚ --",
        addressDetailLabel: "è¯¦ç»†åœ°å€ï¼ˆä»å‡ ä¸ç›®åå¼€å§‹è¾“å…¥ï¼Œä¾‹ï¼š1-2-3 â—‹â—‹ãƒ“ãƒ«3éšï¼‰",
        addressDetailPlaceholder: "ä¾‹å¦‚ï¼š1-2-3ã€1ç•ªåœ°1å·ã€â—‹â—‹ãƒ“ãƒ«3éšï¼ˆå‡ ä¸ç›®å‰é¢çš„å†…å®¹è¯·åœ¨ä¸Šæ–¹ä¸‹æ‹‰é€‰æ‹©ï¼‰",
        catNameLabel: "çŒ«å’ªåå­—",
        catNamePlaceholder: "è¯·è¾“å…¥çŒ«å’ªåå­—",
        catAgeLabel: "çŒ«å’ªå¹´é¾„",
        catAgePlaceholder: "ä¾‹å¦‚ï¼š3å²",
        bookingModeLabel: "é¢„çº¦æ–¹å¼",
        bookingModeSeparate: "åˆ†å¼€æ—¥æœŸï¼ˆä¸è¿ç»­ï¼‰",
        bookingModeRange: "ä¸€æ®µåŒºé—´ï¼ˆè¿ç»­ï¼‰",
        serviceDateSeparateLabel: "æœåŠ¡æ—¥æœŸï¼ˆåˆ†å¼€æ·»åŠ ï¼‰",
        serviceDateRangeLabel: "æœåŠ¡æ—¥æœŸåŒºé—´",
        addDateBtn: "æ·»åŠ æ—¥æœŸ",
        addRangeBtn: "æ·»åŠ åŒºé—´",
        dateHelp: "æ·»åŠ åè¯·ä¸ºæ¯ä¸ªæ—¥æœŸåˆ†åˆ«é€‰æ‹©ä¸Šé—¨æ—¶é—´ï¼›åŒºé—´ä¿®æ”¹æ—¶ä¼šä¿ç•™é‡å æ—¥æœŸçš„æ—¶é—´è®¾ç½®",
        noteLabel: "å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰",
        notePlaceholder: "ä¾‹å¦‚ï¼šçŒ«å’ªæ€§æ ¼ã€ç‰¹æ®Šéœ€æ±‚ç­‰",
        photoLabel: "çŒ«å’ªç…§ç‰‡ï¼ˆå¯é€‰ï¼ŒJPGæ ¼å¼ï¼Œæœ€å¤§5MBï¼‰",
        submitBtn: "æäº¤é¢„çº¦",
        getReservation: "å·²æœ‰é¢„çº¦ï¼Ÿç‚¹æ­¤æ‰¾å›é¢„çº¦ï¼Œéšåè¿›å…¥ç‹¬ç«‹é¡µé¢ä¿®æ”¹æˆ–å–æ¶ˆ",
        selectTime: "-- è¯·é€‰æ‹©ä¸Šé—¨æ—¶é—´ --",
        removeBtn: "åˆ é™¤",
        timeAM: "ä¸Šåˆ 9:00-12:00",
        timePM: "ä¸‹åˆ 13:00-17:00",
        timeEve: "æ™šä¸Š 18:00-21:00",
        required: "*"
      },
      en: {
        pageTitle: "Cat Care Service Booking",
        bookingTitle: "Booking Application",
        contactTypeLabel: "Contact Type",
        contactTypeSelect: "-- Please Select --",
        contactTypePhone: "Phone",
        contactTypeWechat: "WeChat",
        contactTypeEmail: "Email",
        contactLabel: "Contact Information",
        contactPlaceholder: "Phone: 090-1234-5678; Landline: 0456-12-3456; Email: xxx@example.com; WeChat: xxxxxxx",
        ownerNameLabel: "Your Name",
        ownerNamePlaceholder: "Enter your name",
        prefectureLabel: "Service Area (Prefecture)",
        prefectureSelect: "-- Select Prefecture --",
        pref_tokyo: "Tokyo",
        pref_saitama: "Saitama",
        pref_kanagawa: "Kanagawa",
        pref_chiba: "Chiba",
        cityLabel: "Service Area (City)",
        citySelect: "-- Select Prefecture First --",
        districtLabel: "Service Area (District)",
        districtSelect: "-- Select City First --",
        addressDetailLabel: "Detailed Address (From block number, e.g., 1-2-3 â—‹â—‹ Building 3F)",
        addressDetailPlaceholder: "e.g., 1-2-3, 1 Banchi 1 Gou, â—‹â—‹ Building 3F",
        catNameLabel: "Cat's Name",
        catNamePlaceholder: "Enter cat's name",
        catAgeLabel: "Cat's Age",
        catAgePlaceholder: "e.g., 3 years",
        bookingModeLabel: "Booking Mode",
        bookingModeSeparate: "Separate Dates (Non-continuous)",
        bookingModeRange: "Date Range (Continuous)",
        serviceDateSeparateLabel: "Service Dates (Add separately)",
        serviceDateRangeLabel: "Service Date Range",
        addDateBtn: "Add Date",
        addRangeBtn: "Add Range",
        dateHelp: "After adding, please select a service time for each date. When modifying ranges, time settings for overlapping dates will be retained.",
        noteLabel: "Notes (Optional)",
        notePlaceholder: "e.g., Cat's personality, special requirements, etc.",
        photoLabel: "Cat Photo (Optional, JPG format, max 5MB)",
        submitBtn: "Submit Booking",
        getReservation: "Have a booking? Click here to find and manage your reservation",
        selectTime: "-- Select Service Time --",
        removeBtn: "Remove",
        timeAM: "Morning 9:00-12:00",
        timePM: "Afternoon 13:00-17:00",
        timeEve: "Evening 18:00-21:00",
        required: "*"
      },
      ja: {
        pageTitle: "çŒ«ã®ãŠä¸–è©±è¨ªå•äºˆç´„",
        bookingTitle: "äºˆç´„ç”³è«‹",
        contactTypeLabel: "é€£çµ¡æ–¹æ³•ã®ç¨®é¡",
        contactTypeSelect: "-- é¸æŠã—ã¦ãã ã•ã„ --",
        contactTypePhone: "é›»è©±",
        contactTypeWechat: "WeChat",
        contactTypeEmail: "ãƒ¡ãƒ¼ãƒ«",
        contactLabel: "é€£çµ¡æ–¹æ³•",
        contactPlaceholder: "é›»è©±ï¼š090-1234-5678ï¼›å›ºå®šé›»è©±ï¼š0456-12-3456ï¼›ãƒ¡ãƒ¼ãƒ«ï¼šxxx@example.comï¼›WeChatï¼šxxxxxxx",
        ownerNameLabel: "ãŠåå‰",
        ownerNamePlaceholder: "ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
        prefectureLabel: "è¨ªå•åœ°åŸŸï¼ˆéƒ½é“åºœçœŒï¼‰",
        prefectureSelect: "-- éƒ½é“åºœçœŒã‚’é¸æŠ --",
        pref_tokyo: "æ±äº¬éƒ½",
        pref_saitama: "åŸ¼ç‰çœŒ",
        pref_kanagawa: "ç¥å¥ˆå·çœŒ",
        pref_chiba: "åƒè‘‰çœŒ",
        cityLabel: "è¨ªå•åœ°åŸŸï¼ˆå¸‚ï¼‰",
        citySelect: "-- å…ˆãšéƒ½é“åºœçœŒã‚’é¸æŠ --",
        districtLabel: "è¨ªå•åœ°åŸŸï¼ˆåŒºï¼‰",
        districtSelect: "-- å…ˆãšå¸‚ã‚’é¸æŠ --",
        addressDetailLabel: "è©³ç´°ä½æ‰€ï¼ˆä¸ç›®ã®å¾Œã‹ã‚‰å…¥åŠ›ã€ä¾‹ï¼š1-2-3 â—‹â—‹ãƒ“ãƒ«3éšï¼‰",
        addressDetailPlaceholder: "ä¾‹ï¼š1-2-3ã€1ç•ªåœ°1å·ã€â—‹â—‹ãƒ“ãƒ«3éš",
        catNameLabel: "çŒ«ã¡ã‚ƒã‚“ã®ãŠåå‰",
        catNamePlaceholder: "çŒ«ã¡ã‚ƒã‚“ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
        catAgeLabel: "çŒ«ã¡ã‚ƒã‚“ã®å¹´é½¢",
        catAgePlaceholder: "ä¾‹ï¼š3æ­³",
        bookingModeLabel: "äºˆç´„æ–¹å¼",
        bookingModeSeparate: "å€‹åˆ¥æ—¥ä»˜ï¼ˆéé€£ç¶šï¼‰",
        bookingModeRange: "æ—¥ä»˜ç¯„å›²ï¼ˆé€£ç¶šï¼‰",
        serviceDateSeparateLabel: "è¨ªå•æ—¥ï¼ˆå€‹åˆ¥ã«è¿½åŠ ï¼‰",
        serviceDateRangeLabel: "è¨ªå•æ—¥ç¨‹ç¯„å›²",
        addDateBtn: "æ—¥ä»˜ã‚’è¿½åŠ ",
        addRangeBtn: "ç¯„å›²ã‚’è¿½åŠ ",
        dateHelp: "è¿½åŠ å¾Œã€å„æ—¥ä»˜ã®è¨ªå•æ™‚é–“ã‚’ãã‚Œãã‚Œé¸æŠã—ã¦ãã ã•ã„ã€‚ç¯„å›²ã®å¤‰æ›´æ™‚ã¯ã€é‡è¤‡ã™ã‚‹æ—¥ä»˜ã®æ™‚é–“è¨­å®šãŒä¿æŒã•ã‚Œã¾ã™",
        noteLabel: "å‚™è€ƒï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰",
        notePlaceholder: "ä¾‹ï¼šçŒ«ã¡ã‚ƒã‚“ã®æ€§æ ¼ã€ç‰¹åˆ¥ãªè¦æœ›ãªã©",
        photoLabel: "çŒ«ã¡ã‚ƒã‚“ã®å†™çœŸï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€JPGå½¢å¼ã€æœ€å¤§5MBï¼‰",
        submitBtn: "äºˆç´„ã‚’é€ä¿¡",
        getReservation: "æ—¢ã«äºˆç´„ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦äºˆç´„ã‚’ç¢ºèªã—ã€å¤‰æ›´ã¾ãŸã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ãã ã•ã„",
        selectTime: "-- è¨ªå•æ™‚é–“ã‚’é¸æŠ --",
        removeBtn: "å‰Šé™¤",
        timeAM: "åˆå‰ 9:00-12:00",
        timePM: "åˆå¾Œ 13:00-17:00",
        timeEve: "å¤œé–“ 18:00-21:00",
        required: "*"
      }
    };

    window.currentLang = localStorage.getItem("bookingLang") || "zh";

    function applyLanguage(lang) {
      var dict = window.I18N[lang] || window.I18N.zh;
      window.currentLang = lang;
      document.documentElement.lang = lang === "zh" ? "zh-CN" : lang;
      document.title = dict.pageTitle;

      // æ›´æ–°æ‰€æœ‰ data-i18n å±æ€§çš„å…ƒç´ 
      var nodes = document.querySelectorAll("[data-i18n]");
      nodes.forEach(function(node) {
        var key = node.getAttribute("data-i18n");
        if (dict[key]) {
          if (node.tagName === "INPUT" || node.tagName === "TEXTAREA") {
            node.placeholder = dict[key];
          } else {
            node.textContent = dict[key];
          }
        }
      });

      // æ›´æ–° option å…ƒç´ 
      document.querySelectorAll("option[data-i18n]").forEach(function(opt) {
        var key = opt.getAttribute("data-i18n");
        if (dict[key]) opt.textContent = dict[key];
      });

      // æ›´æ–°æŒ‰é’®æ–‡æœ¬
      var buttons = document.querySelectorAll("button[data-i18n]");
      buttons.forEach(function(btn) {
        var key = btn.getAttribute("data-i18n");
        if (dict[key]) btn.textContent = dict[key];
      });

      // æ›´æ–°èšç„¦çš„è¯­è¨€æŒ‰é’®
      var langOptions = document.querySelectorAll(".lang-option");
      langOptions.forEach(function(opt) {
        opt.classList.toggle("active", opt.getAttribute("data-lang") === lang);
      });

      localStorage.setItem("bookingLang", lang);

      // æ›´æ–°åŠ¨æ€å†…å®¹
      updateTimeOptions(dict);
    }

    function updateTimeOptions(dict) {
      window.TIME_OPTIONS = [
        dict.timeAM,
        dict.timePM,
        dict.timeEve
      ];
      // é‡æ–°æ¸²æŸ“å·²æœ‰çš„è®¿é—®åˆ—è¡¨
      renderVisitList();
    }

    document.addEventListener("DOMContentLoaded", function() {
      var buttons = document.querySelectorAll(".lang-option");
      buttons.forEach(function(btn) {
        btn.addEventListener("click", function() {
          applyLanguage(this.getAttribute("data-lang"));
        });
      });
      applyLanguage(window.currentLang);
    });
    // ===== å¤šè¯­è¨€ç³»ç»Ÿç»“æŸ =====

    // ç…§ç‰‡é¢„è§ˆåŠŸèƒ½
    document.getElementById("photo").addEventListener("change", function() {
      var preview = document.getElementById("photoPreview");
      preview.innerHTML = "";
      
      if (this.files && this.files[0]) {
        var file = this.files[0];
        
        // éªŒè¯æ–‡ä»¶å¤§å°
        if (file.size > 5 * 1024 * 1024) {
          showMessage("âŒ æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©5MBä»¥å†…çš„æ–‡ä»¶", "error");
          this.value = "";
          return;
        }
        
        // éªŒè¯æ–‡ä»¶æ ¼å¼
        if (file.type !== "image/jpeg" && file.type !== "image/jpg") {
          showMessage("âŒ ä»…æ”¯æŒJPG/JPEGæ ¼å¼", "error");
          this.value = "";
          return;
        }
        
        // æ˜¾ç¤ºé¢„è§ˆå›¾
        var reader = new FileReader();
        reader.onload = function(e) {
          var img = document.createElement("img");
          img.src = e.target.result;
          img.style.width = "100%";
          img.style.borderRadius = "8px";
          img.style.border = "2px solid #FFD1DB";
          preview.appendChild(img);
          preview.appendChild(document.createElement("br"));
          var fileName = document.createElement("small");
          fileName.textContent = "âœ… " + file.name + " (" + (file.size / 1024).toFixed(2) + "KB)";
          fileName.style.color = "#999";
          preview.appendChild(fileName);
        };
        reader.readAsDataURL(file);
      }
    }, false);
  </script>
</body>
</html>